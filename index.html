<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MindReader V1.0</title>
    <style>
        /* --- 1. è§†è§‰ç³»ç»Ÿ (V1.0 Professional) --- */
        :root {
            --bg: #050505;
            --glass: rgba(30, 30, 30, 0.85);
            --border: rgba(255, 255, 255, 0.15);
            --accent: #007aff; /* iOS è“ï¼Œæ›´ä¸“ä¸š */
            --warn: #ffcc00;
            --danger: #ff3b30;
            --text: #ffffff;
        }

        body {
            background: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
        }

        .app { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; height: 100%; }

        /* --- 2. é¡¶éƒ¨é¢˜ç›®æ  --- */
        .hud {
            min-height: 100px; background: var(--glass); border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 10px 20px; z-index: 50; flex-shrink: 0; position: relative; backdrop-filter: blur(20px);
        }
        .phase-badge {
            font-size: 10px; font-weight: 600; letter-spacing: 1px; padding: 4px 8px;
            border-radius: 4px; margin-bottom: 8px; text-transform: uppercase; background: rgba(255,255,255,0.1);
        }
        .q-text { font-size: 17px; font-weight: 600; text-align: center; line-height: 1.4; max-width: 600px; }
        .progress { position: absolute; bottom: 0; left: 0; height: 3px; background: var(--accent); width: 0%; transition: width 0.1s linear; }

        /* --- 3. ç›‘æ§ç”»é¢ --- */
        .viewport {
            flex: 1; position: relative; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        #main_canvas {
            width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1);
        }

        /* å®æ—¶åé¦ˆæ ‡ç­¾ */
        .detect-tags {
            position: absolute; top: 10px; right: 10px; display: flex; flex-direction: column; gap: 6px; pointer-events: none;
        }
        .tag {
            background: rgba(0,0,0,0.7); padding: 6px 12px; border-radius: 6px; font-size: 11px;
            font-weight: 500; border-left: 3px solid; opacity: 0; transition: opacity 0.2s; backdrop-filter: blur(4px);
        }
        .tag.active { opacity: 1; }
        .tag.danger { border-color: var(--danger); color: #ff8a84; }
        .tag.warn { border-color: var(--warn); color: #ffe684; }
        .tag.info { border-color: var(--accent); color: #84c1ff; }

        /* --- 4. åº•éƒ¨ä»ªè¡¨ç›˜ --- */
        .dashboard {
            height: 120px; background: var(--glass); border-top: 1px solid var(--border);
            display: flex; gap: 10px; padding: 15px; flex-shrink: 0; overflow-x: auto;
            backdrop-filter: blur(20px); padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }
        .dash-card {
            flex: 1; min-width: 90px; background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            border-radius: 8px; position: relative; overflow: hidden;
        }
        .dash-label { position: absolute; top: 5px; left: 5px; font-size: 9px; color: rgba(255,255,255,0.6); font-weight: 600; }
        .mini-canvas { width: 100%; height: 100%; opacity: 0.8; }

        /* --- 5. å¯åŠ¨é¡µ (ä¸“ä¸šå¼•å¯¼é£æ ¼) --- */
        .layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: opacity 0.3s; padding: 30px; box-sizing: border-box;
        }
        .layer.hidden { opacity: 0; pointer-events: none; }

        .guide-box {
            background: #111; border: 1px solid #333; border-radius: 20px; padding: 30px;
            max-width: 400px; width: 100%; text-align: center;
        }
        .guide-icon { font-size: 40px; margin-bottom: 20px; display: block; }
        .guide-item {
            display: flex; align-items: center; text-align: left; margin: 15px 0; font-size: 13px; color: #ccc;
            background: #222; padding: 12px; border-radius: 10px;
        }
        .guide-emoji { font-size: 20px; margin-right: 15px; width: 30px; text-align: center; }

        .btn-main {
            margin-top: 20px; width: 100%; padding: 16px 0; border-radius: 12px; border: none;
            background: var(--accent); color: #fff; font-size: 16px; font-weight: 600; cursor: pointer;
        }
        .btn-main:active { opacity: 0.8; transform: scale(0.98); }

        /* æŠ¥å‘Šé¡µ */
        .report-box { width: 100%; height: 100%; overflow-y: auto; padding: 20px; box-sizing: border-box; background: #050505; }
        .evidence-row { display: flex; gap: 10px; margin-bottom: 30px; margin-top: 10px; }
        .photo-card { flex: 1; background: #111; border: 1px solid #333; border-radius: 8px; overflow: hidden; }
        .photo-img { width: 100%; height: auto; display: block; border-bottom: 1px solid #333; }
        .photo-meta { padding: 8px; font-size: 10px; text-align: center; color: #888; text-transform: uppercase; font-weight: 600; }
       Â 
        .log-item {
            background: #111; padding: 15px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #222;
        }
        .log-item.stress { border-left: 4px solid var(--danger); }
        .log-item.baseline { border-left: 4px solid var(--accent); }

        #src_video { display: none; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="layer" id="layer_start">
    <div class="guide-box">
        <h1 style="margin:0 0 5px 0; font-size: 24px;">MindReader <span style="font-size:14px; color:#666; vertical-align: middle;">V1.0</span></h1>
        <p style="color:#666; font-size:13px; margin-bottom:30px">éè¯­è¨€è¡Œä¸ºåˆ†æç³»ç»Ÿ</p>
       Â 
        <div class="guide-item">
            <div class="guide-emoji">ğŸ“</div>
            <div>
                <div style="color:#fff; font-weight:600">ä¿æŒè·ç¦»</div>
                <div>è¯·å°†æ‰‹æœºæ”¾ç½®åœ¨ 50-80cm å¤„</div>
            </div>
        </div>
        <div class="guide-item">
            <div class="guide-emoji">ğŸ‘¤</div>
            <div>
                <div style="color:#fff; font-weight:600">è°ƒæ•´æ„å›¾</div>
                <div>ç¡®ä¿é¢éƒ¨ã€ä¸ŠåŠèº«ã€åŒæ‰‹å‡åœ¨ç”»é¢å†…</div>
            </div>
        </div>
        <div class="guide-item">
            <div class="guide-emoji">ğŸ’¡</div>
            <div>
                <div style="color:#fff; font-weight:600">ç¯å¢ƒå…‰çº¿</div>
                <div>è¯·åœ¨å…‰çº¿å……è¶³çš„ç¯å¢ƒä¸‹æµ‹è¯•ï¼Œé¿å…é€†å…‰</div>
            </div>
        </div>

        <button class="btn-main" onclick="startSystem()">æˆ‘å·²å‡†å¤‡å°±ç»ª</button>
    </div>
</div>

<div class="app">
    <div class="hud">
        <div class="phase-badge" id="hud_badge" style="color:var(--accent)">SYSTEM READY</div>
        <div class="q-text" id="hud_text">æ­£åœ¨åˆå§‹åŒ–ä¼ æ„Ÿå™¨...</div>
        <div class="progress" id="hud_bar"></div>
    </div>

    <div class="viewport">
        <div class="detect-tags">
            <div class="tag danger" id="tag_nose">ğŸ¤¥ è§¦ç¢°é¢éƒ¨ (æ©é¥°)</div>
            <div class="tag warn" id="tag_chin">ğŸ¤” è§¦ç¢°ä¸‹å·´ (è¯„ä¼°)</div>
            <div class="tag warn" id="tag_fidget">ğŸ¤ æ‰‹éƒ¨æ‘©æŒ² (ç„¦è™‘)</div>
            <div class="tag info" id="tag_shock">ğŸ˜² çœ¼éƒ¨æ‰©å¼  (æƒŠè®¶)</div>
            <div class="tag danger" id="tag_cross">ğŸ™…â€â™‚ï¸ åŒè‡‚äº¤å‰ (é˜²å¾¡)</div>
        </div>
        <canvas id="main_canvas"></canvas>
    </div>

    <div class="dashboard">
        <div class="dash-card"><div class="dash-label">FACE MESH</div><canvas id="cv_face" class="mini-canvas"></canvas></div>
        <div class="dash-card"><div class="dash-label">BODY POSE</div><canvas id="cv_pose" class="mini-canvas"></canvas></div>
        <div class="dash-card"><div class="dash-label">HANDS</div><canvas id="cv_hands" class="mini-canvas"></canvas></div>
    </div>
</div>

<div class="layer hidden" id="layer_report">
    <div class="report-box">
        <h2 style="text-align:center; color:#fff; margin-bottom:10px; font-size:20px">è¡Œä¸ºåˆ†ææ¡£æ¡ˆ</h2>
        <div style="text-align:center; color:#666; font-size:12px; margin-bottom:30px">AUTOMATED BEHAVIORAL ANALYSIS REPORT</div>
       Â 
        <div style="font-size:11px; color:#666; font-weight:bold; letter-spacing:1px">å…³é”®å¸§è¯æ®å¯¹æ¯”</div>
        <div class="evidence-row" id="evidence_area">
            </div>

        <div style="font-size:11px; color:#666; font-weight:bold; letter-spacing:1px; margin-top:20px">è¯¦ç»†è¡Œä¸ºæµæ°´</div>
        <div id="log_area" style="margin-top:10px"></div>

        <button class="btn-main" style="background:#333; border:1px solid #555; margin-top:30px" onclick="location.reload()">ç»“æŸå¹¶é‡ç½®</button>
    </div>
</div>

<video id="src_video" playsinline></video>

<script>
    // --- é¢˜åº“ç³»ç»Ÿ ---
    const POOL_BASE = ["è¯·æ”¾æ¾ï¼Œç®€å•ä»‹ç»ä¸€ä¸‹ä½ çš„å·¥ä½œæˆ–å­¦ä¹ ï¼Ÿ", "ä½ æœ€å–œæ¬¢çš„æ—…è¡Œç›®çš„åœ°æ˜¯å“ªé‡Œï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ"];
    const POOL_STRESS = [
        "ã€é«˜å‹ã€‘çœ‹ç€æˆ‘ã€‚ä½ æœ€è¿‘æ˜¯å¦å¯¹èº«è¾¹çš„äººæ’’è¿‡è°ï¼Ÿ",
        "ã€ä¸¤éš¾ã€‘å¦‚æœå¿…é¡»åœ¨äº‹ä¸šå’Œå®¶åº­ä¸­ç‰ºç‰²ä¸€ä¸ªï¼Œä½ é€‰å“ªä¸ªï¼Ÿ",
        "ã€å®¡è®¯ã€‘ä½ æ˜¯å¦æ›¾ç»åˆ©ç”¨è¿‡åˆ«äººçš„ä¿¡ä»»æ¥è·åˆ©ï¼Ÿ"
    ];

    let SCRIPT = [];
    let sessionData = [];
    let currentQ = null;
    let evidence = { baseline: null, anomaly: null, maxScore: 0 };
    let tempStats = {Â 
        blinks: 0, baseEyeHeight: 0, noseTouchCount: 0, chinTouchCount: 0,Â 
        fidgetCount: 0, shockCount: 0, frames: 0Â 
    };

    // --- å¯åŠ¨é€»è¾‘ ---
    async function startSystem() {
        // éšæœºç»„é¢˜
        SCRIPT = [
            { id: 1, type: 'baseline', time: 8, text: POOL_BASE[Math.floor(Math.random()*POOL_BASE.length)] },
            { id: 2, type: 'baseline', time: 8, text: "å¥½çš„ã€‚å¹³æ—¶å‘¨æœ«ä½ ä¸€èˆ¬å‡ ç‚¹èµ·åºŠï¼Ÿ" },
            { id: 3, type: 'stress', time: 10, text: POOL_STRESS[Math.floor(Math.random()*POOL_STRESS.length)] },
            { id: 4, type: 'stress', time: 10, text: "è¯·è¯šå®å›ç­”ï¼šä½ åˆšæ‰åœ¨å›ç­”é—®é¢˜æ—¶æ˜¯å¦æ„Ÿåˆ°å¿ƒè™šï¼Ÿ" }
        ];

        document.getElementById('layer_start').classList.add('hidden');
       Â 
        const video = document.getElementById('src_video');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: "user" } });
            video.srcObject = stream;
            await video.play();

            const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
            holistic.setOptions({modelComplexity: 1, minDetectionConfidence: 0.5, refineFaceLandmarks: true});
            holistic.onResults(onResults);
           Â 
            const camera = new Camera(video, {
                onFrame: async () => { await holistic.send({image: video}); },
                width: 640, height: 480
            });
            camera.start();

            setTimeout(() => runQuestion(0), 2000);
        } catch (e) { alert("æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®"); }
    }

    // --- æµç¨‹æ§åˆ¶ ---
    function runQuestion(index) {
        if (index >= SCRIPT.length) { generateReport(); return; }

        if (index === 2 && !evidence.baseline) captureEvidence('baseline');

        currentQ = SCRIPT[index];
        const oldBase = tempStats.baseEyeHeight;
        tempStats = { blinks: 0, noseTouchCount: 0, chinTouchCount: 0, fidgetCount: 0, shockCount: 0, frames: 0, lastEyeOpen: true, baseEyeHeight: oldBase };

        // UI æ›´æ–°
        const isBase = currentQ.type === 'baseline';
        const badge = document.getElementById('hud_badge');
        badge.innerText = isBase ? `BASELINE #${currentQ.id}` : `STRESS TEST #${currentQ.id}`;
        badge.style.color = isBase ? 'var(--accent)' : 'var(--danger)';
       Â 
        document.getElementById('hud_text').innerText = currentQ.text;
       Â 
        const bar = document.getElementById('hud_bar');
        bar.style.transition = 'none'; bar.style.width = '0%';
        setTimeout(() => { bar.style.transition = `width ${currentQ.time}s linear`; bar.style.width = '100%'; }, 50);

        setTimeout(() => {
            saveData();
            runQuestion(index + 1);
        }, currentQ.time * 1000);
    }

    function captureEvidence(type) {
        const canvas = document.getElementById('main_canvas');
        evidence[type] = canvas.toDataURL('image/jpeg', 0.8);
    }

    function saveData() {
        sessionData.push({ q: currentQ, stats: { ...tempStats } });
    }

    // --- æ ¸å¿ƒåˆ†æé€»è¾‘ ---
    const canvas = document.getElementById('main_canvas');
    const ctx = canvas.getContext('2d');
    const sideCtx = {
        face: document.getElementById('cv_face').getContext('2d'),
        pose: document.getElementById('cv_pose').getContext('2d'),
        hands: document.getElementById('cv_hands').getContext('2d')
    };

    function onResults(results) {
        const video = document.getElementById('src_video');
        const vW = video.videoWidth; const vH = video.videoHeight;
        if(vW) {
            canvas.width = vW; canvas.height = vH;
            ctx.save(); ctx.clearRect(0, 0, vW, vH); ctx.drawImage(video, 0, 0, vW, vH);
        } else { ctx.restore(); return; }

        if (!results.faceLandmarks) { ctx.restore(); return; }

        const face = results.faceLandmarks;
        const noseTip = face[1]; const chinTip = face[152];
        const eyeHeight = Math.abs(face[159].y - face[145].y);

        if (currentQ && currentQ.type === 'baseline') {
            tempStats.baseEyeHeight = (tempStats.baseEyeHeight * tempStats.frames + eyeHeight) / (tempStats.frames + 1);
        }

        drawConnectors(ctx, face, FACEMESH_TESSELATION, {color: '#ffffff11', lineWidth: 0.5});

        let anomalyScore = 0;
        const tags = { nose: false, chin: false, fidget: false, shock: false, cross: false };

        // 1. æƒŠè®¶æ£€æµ‹
        if (currentQ && currentQ.type === 'stress' && tempStats.baseEyeHeight > 0) {
            if (eyeHeight > tempStats.baseEyeHeight * 1.35) {
                tags.shock = true; tempStats.shockCount++; anomalyScore += 5;
            }
        }

        // 2. æ‰‹éƒ¨é€»è¾‘
        const checkHand = (hand) => {
            if (!hand) return;
            const index = hand[8]; const thumb = hand[4];
           Â 
            // æ‘¸é¼»
            if (Math.sqrt(Math.pow(index.x - noseTip.x, 2) + Math.pow(index.y - noseTip.y, 2)) < 0.05) {
                tags.nose = true; tempStats.noseTouchCount++; anomalyScore += 10;
                ctx.beginPath(); ctx.arc(noseTip.x * vW, noseTip.y * vH, 30, 0, 2*Math.PI);
                ctx.strokeStyle = 'var(--danger)'; ctx.lineWidth = 3; ctx.stroke();
            }
            // æ‘¸ä¸‹å·´
            else if (Math.sqrt(Math.pow(index.x - chinTip.x, 2) + Math.pow(index.y - chinTip.y, 2)) < 0.08) {
                tags.chin = true; tempStats.chinTouchCount++; anomalyScore += 3;
            }
            // æ“æ‰‹æŒ‡
            if (Math.sqrt(Math.pow(index.x - thumb.x, 2) + Math.pow(index.y - thumb.y, 2)) < 0.03) {
                tags.fidget = true; tempStats.fidgetCount++; anomalyScore += 2;
            }
        };

        if (results.leftHandLandmarks) checkHand(results.leftHandLandmarks);
        if (results.rightHandLandmarks) checkHand(results.rightHandLandmarks);

        // 3. æŠ±èƒ¸æ£€æµ‹
        if(results.poseLandmarks) {
             const pose = results.poseLandmarks;
             const lWrist = pose[15]; const rWrist = pose[16];
             const lShldr = pose[11]; const rHip = pose[24];
             // ç®€å•åˆ¤å®šï¼šæ‰‹è…•åœ¨èº¯å¹²é«˜åº¦èŒƒå›´å†…ï¼Œä¸”æ°´å¹³è·ç¦»è¿‘
             if (lWrist.y > lShldr.y && lWrist.y < rHip.y && Math.abs(lWrist.x - rWrist.x) < 0.15) {
                 tags.cross = true; anomalyScore += 4;
             }
        }

        // æ›´æ–°æ ‡ç­¾çŠ¶æ€
        document.getElementById('tag_nose').className = `tag danger ${tags.nose ? 'active' : ''}`;
        document.getElementById('tag_chin').className = `tag warn ${tags.chin ? 'active' : ''}`;
        document.getElementById('tag_fidget').className = `tag warn ${tags.fidget ? 'active' : ''}`;
        document.getElementById('tag_shock').className = `tag info ${tags.shock ? 'active' : ''}`;
        document.getElementById('tag_cross').className = `tag danger ${tags.cross ? 'active' : ''}`;

        // æ™ºèƒ½æŠ“æ‹
        if (currentQ && currentQ.type === 'stress' && anomalyScore > evidence.maxScore) {
            evidence.maxScore = anomalyScore;
            captureEvidence('anomaly');
        }

        ctx.restore();
        drawSide(sideCtx.face, results.faceLandmarks, FACEMESH_TESSELATION, '#007aff');
        drawSide(sideCtx.pose, results.poseLandmarks, POSE_CONNECTIONS, '#fff');
        drawSide(sideCtx.hands, results.leftHandLandmarks || results.rightHandLandmarks, HAND_CONNECTIONS, '#ff3b30');

        if(currentQ) tempStats.frames++;
    }

    function drawSide(c, data, conn, color) {
        c.canvas.width=150; c.canvas.height=150; c.clearRect(0,0,150,150);
        if(data) { c.save(); drawConnectors(c, data, conn, {color: color, lineWidth: 2}); c.restore(); }
    }

    // --- æŠ¥å‘Šç”Ÿæˆ ---
    function generateReport() {
        document.getElementById('layer_report').classList.remove('hidden');
       Â 
        const evArea = document.getElementById('evidence_area');
        const imgBase = evidence.baseline || "";
        const imgAnom = evidence.anomaly || imgBase;Â 
       Â 
        evArea.innerHTML = `
            <div class="photo-card">
                <img src="${imgBase}" class="photo-img">
                <div class="photo-meta" style="color:var(--accent)">åŸºå‡†çŠ¶æ€ (Baseline)</div>
            </div>
            <div class="photo-card" style="border-color:var(--danger)">
                <img src="${imgAnom}" class="photo-img">
                <div class="photo-meta" style="color:var(--danger)">å‹åŠ›ååº” (Reaction)</div>
            </div>
        `;

        const logArea = document.getElementById('log_area');
        let html = "";
       Â 
        sessionData.forEach(d => {
            const isStress = d.q.type === 'stress';
            let signals = [];
           Â 
            if (d.stats.noseTouchCount > 5) signals.push("è§¦ç¢°é¢éƒ¨æ©é¥°");
            if (d.stats.chinTouchCount > 10) signals.push("è§¦ç¢°ä¸‹å·´è¯„ä¼°");
            if (d.stats.shockCount > 5) signals.push("çœ¼éƒ¨æƒŠè®¶ååº”");
            if (d.stats.fidgetCount > 20) signals.push("æ‰‹éƒ¨ç„¦è™‘æ‘©æŒ²");

            const hasSignal = signals.length > 0;
            html += `
                <div class="log-item ${d.q.type}">
                    <div style="font-size:10px; color:#888; margin-bottom:5px">${d.q.type.toUpperCase()}</div>
                    <div style="font-size:14px; color:#fff; font-weight:600; margin-bottom:8px">"${d.q.text}"</div>
                    ${hasSignal ? `<div style="color:#ff8a84; font-size:12px; font-weight:bold">âš  æ£€æµ‹åˆ°: ${signals.join(", ")}</div>` : '<div style="font-size:12px; color:#666">è¡Œä¸ºååº”å¹³ç¨³</div>'}
                </div>
            `;
        });
        logArea.innerHTML = html;
    }
</script>
</body>
</html>
