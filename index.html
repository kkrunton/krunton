<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MindReader V13 - Interrogator</title>
    <style>
        /* --- 1. åŸºç¡€æ¶æ„ --- */
        :root { --bg: #000; --panel: rgba(20,20,20,0.9); --accent: #00f2ff; --warn: #ffcc00; --danger: #ff3366; }
        body { background: var(--bg); color: #fff; margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; font-family: -apple-system, sans-serif; }

        /* --- 2. é¡¶éƒ¨æé—®å¡ç‰‡ (æ ¸å¿ƒäº¤äº’åŒº) --- */
        .question-card {
            height: 140px; background: var(--panel); border-bottom: 1px solid #333;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 10px 20px; z-index: 50; flex-shrink: 0; position: relative;
        }
        .phase-badge {Â 
            font-size: 10px; text-transform: uppercase; letter-spacing: 1px;Â 
            padding: 2px 8px; border-radius: 4px; margin-bottom: 10px; background: #333; color: #888;
        }
        .question-text {Â 
            font-size: 18px; font-weight: bold; text-align: center; line-height: 1.4;
            min-height: 50px; display: flex; align-items: center;
        }
        .timer-bar {Â 
            position: absolute; bottom: 0; left: 0; height: 4px; background: var(--accent);Â 
            width: 0%; transition: width 1s linear;Â 
        }

        /* --- 3. å®æ—¶æ‰«æåé¦ˆåŒº (Zone A/B/C) --- */
        .scan-overlay {
            position: absolute; top: 10px; right: 10px; width: 120px;
            display: flex; flex-direction: column; gap: 5px; pointer-events: none;
        }
        .alert-tag {
            background: rgba(255, 51, 102, 0.2); border: 1px solid var(--danger);
            color: var(--danger); font-size: 10px; padding: 4px 8px; border-radius: 4px;
            display: none; /* é»˜è®¤éšè—ï¼Œè§¦å‘æ—¶æ˜¾ç¤º */
            animation: flash 0.5s infinite alternate;
        }
        @keyframes flash { from { opacity: 0.5; } to { opacity: 1; } }

        /* --- 4. ä¸»èˆå° --- */
        .stage { flex: 1; position: relative; background: #050505; display: flex; justify-content: center; align-items: center; }
        #output_canvas { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* --- 5. åº•éƒ¨ä¾§è¾¹æ  --- */
        .sidebar { height: 100px; background: #111; border-top: 1px solid #333; display: flex; padding: 10px; gap: 10px; flex-shrink: 0; overflow-x: auto; }
        .preview-card { flex: 1; background: #222; border-radius: 6px; min-width: 80px; position: relative; border: 1px solid #444; }
        .card-label { position: absolute; top: 2px; left: 4px; font-size: 8px; color: #666; }
        .side-canvas { width: 100%; height: 100%; }

        /* --- 6. æ§åˆ¶æŒ‰é’® --- */
        .fab-btn {
            position: absolute; bottom: 120px; right: 20px;
            padding: 12px 24px; border-radius: 30px; font-weight: bold;
            background: var(--accent); color: #000; border: none;
            box-shadow: 0 4px 15px rgba(0, 242, 255, 0.3); z-index: 100;
        }
        .fab-btn.running { background: #333; color: #fff; pointer-events: none; }

        /* éšå½¢æº */
        .hidden { position: absolute; opacity: 0; pointer-events: none; width: 1px; height: 1px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="question-card">
    <div class="phase-badge" id="phase_badge">å‡†å¤‡å°±ç»ª</div>
    <div class="question-text" id="q_text">è¯·ç¡®ä¿è¢«æµ‹å¯¹è±¡ä½äºç”»é¢ä¸­å¤®<br>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹å¿ƒç†æµ‹è¯•</div>
    <div class="timer-bar" id="timer_bar"></div>
</div>

<div class="stage">
    <div class="scan-overlay" id="alert_box">
        <div class="alert-tag" id="alert_blink">ZONE A: çœ¨çœ¼çˆ†å‘</div>
        <div class="alert-tag" id="alert_lip">ZONE A: å˜´å”‡æ¶ˆå¤±</div>
        <div class="alert-tag" id="alert_touch">ZONE B: æŠšæ‘¸åé¢ˆ</div>
        <div class="alert-tag" id="alert_freeze">ZONE B: åŠ¨ä½œå†»ç»“</div>
        <div class="alert-tag" id="alert_shrug">ZONE C: é¾Ÿç¼©ååº”</div>
        <div class="alert-tag" id="alert_turn">ZONE C: èº¯å¹²é€ƒç¦»</div>
    </div>
    <canvas id="output_canvas"></canvas>
</div>

<div class="sidebar">
    <div class="preview-card"><span class="card-label">FACE</span><canvas id="cv_face" class="side-canvas"></canvas></div>
    <div class="preview-card"><span class="card-label">POSE</span><canvas id="cv_pose" class="side-canvas"></canvas></div>
    <div class="preview-card"><span class="card-label">HANDS</span><canvas id="cv_hands" class="side-canvas"></canvas></div>
</div>

<video id="src_video" class="hidden" playsinline></video>
<img id="src_img" class="hidden">
<input type="file" id="file_input" accept="image/*" style="display: none;">

<button class="fab-btn" id="main_btn">å¼€å§‹æµ‹è¯• (ä¸Šä¼ ç…§ç‰‡)</button>

<script>
    // --- é…ç½® ---
    const QUESTIONS = [
        { text: "1. è¯·çœ‹ç€é•œå¤´ï¼Œéšä¾¿èŠèŠä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ", time: 5, type: "baseline" }, // åŸºå‡† 5ç§’
        { text: "2. æ‚¨å¹³æ—¶æ”¾æ¾çš„æ—¶å€™æ‰‹å–œæ¬¢æ”¾åœ¨å“ªé‡Œï¼Ÿ", time: 5, type: "baseline" }, // åŸºå‡† 5ç§’
        { text: "3. æœ€è¿‘ä¸€æ¬¡ç¡ä¸ªå¥½è§‰æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ", time: 5, type: "baseline" }, // åŸºå‡† 5ç§’
        { text: "âš ï¸ å…³é”®æé—®ï¼š\nå¦‚æœä½ æ¯äº²å’Œå¥³å‹åŒæ—¶æ‰æ²³é‡Œï¼Œä½ æ•‘è°ï¼Ÿ", time: 8, type: "stress" } // æ–½å‹ 8ç§’
    ];

    // --- çŠ¶æ€å˜é‡ ---
    let currentState = "idle"; // idle, running, finished
    let currentQIndex = 0;
    let baselineStats = { blinkRate: 0, shoulderY: 0, handVel: 0 };
    let frameCount = 0;
    let blinkCount = 0;
    let lastEyeAspect = 0;
    let lastHandPos = null;

    // --- DOM ---
    const qText = document.getElementById('q_text');
    const pBadge = document.getElementById('phase_badge');
    const tBar = document.getElementById('timer_bar');
    const mainBtn = document.getElementById('main_btn');
    const alerts = {
        blink: document.getElementById('alert_blink'),
        lip: document.getElementById('alert_lip'),
        touch: document.getElementById('alert_touch'),
        freeze: document.getElementById('alert_freeze'),
        shrug: document.getElementById('alert_shrug'),
        turn: document.getElementById('alert_turn')
    };
   Â 
    // --- æ ¸å¿ƒé€»è¾‘ ---

    // 1. å¯åŠ¨æµ‹è¯•æµç¨‹
    function startInterview() {
        currentState = "running";
        currentQIndex = 0;
        baselineStats = { blinkRate: 0, shoulderY: 0, handVel: 0 };
        mainBtn.classList.add('running');
        mainBtn.innerText = "æµ‹è¯•è¿›è¡Œä¸­...";
        nextQuestion();
    }

    // 2. åˆ‡æ¢é—®é¢˜
    function nextQuestion() {
        if (currentQIndex >= QUESTIONS.length) {
            endInterview();
            return;
        }

        const q = QUESTIONS[currentQIndex];
        qText.innerText = q.text;
       Â 
        // UI çŠ¶æ€æ›´æ–°
        if (q.type === 'baseline') {
            pBadge.innerText = `åŸºå‡†æ ¡å‡† (${currentQIndex + 1}/${QUESTIONS.length})`;
            pBadge.style.color = "#00f2ff";
            pBadge.style.border = "1px solid #00f2ff";
        } else {
            pBadge.innerText = "ğŸ”¥ æ–½å‹æ¢æµ‹é˜¶æ®µ ğŸ”¥";
            pBadge.style.color = "#ff3366";
            pBadge.style.border = "1px solid #ff3366";
            // æ–½å‹é˜¶æ®µæ¸…ç©ºä¹‹å‰çš„è­¦æŠ¥
            resetAlerts();
        }

        // å€’è®¡æ—¶æ¡åŠ¨ç”»
        tBar.style.transition = 'none';
        tBar.style.width = '0%';
        setTimeout(() => {
            tBar.style.transition = `width ${q.time}s linear`;
            tBar.style.width = '100%';
        }, 50);

        // å®šæ—¶è¿›å…¥ä¸‹ä¸€é¢˜
        setTimeout(() => {
            currentQIndex++;
            nextQuestion();
        }, q.time * 1000);
    }

    function endInterview() {
        currentState = "finished";
        qText.innerText = "æµ‹è¯•ç»“æŸ\nè¯·æŸ¥çœ‹å³ä¸Šæ–¹æ ‡è®°çš„å¼‚å¸¸ååº”";
        pBadge.innerText = "æŠ¥å‘Šç”Ÿæˆ";
        mainBtn.classList.remove('running');
        mainBtn.innerText = "é‡æ–°å¼€å§‹";
    }

    // 3. AI åˆ†ææ¯ä¸€å¸§ (The Brain)
    function analyzeFrame(results) {
        if (currentState !== "running") return;
        const currentType = QUESTIONS[currentQIndex]?.type || "idle";

        if (!results.faceLandmarks || !results.poseLandmarks) return;

        // --- ZONE A: å¤´éƒ¨æ‰«æ ---
       Â 
        // A1. çœ¨çœ¼æ£€æµ‹ (EAR ç®€åŒ–ç‰ˆ: æ¯”è¾ƒä¸Šä¸‹çœ¼ç‘è·ç¦»)
        const leftEyeTop = results.faceLandmarks[159];
        const leftEyeBottom = results.faceLandmarks[145];
        const eyeDist = Math.abs(leftEyeTop.y - leftEyeBottom.y);
       Â 
        // åˆ¤å®šçœ¨çœ¼ (é˜ˆå€¼éœ€æ ¹æ®å®é™…å¾®è°ƒï¼Œè¿™é‡Œç”¨ 0.02)
        if (eyeDist < 0.02 && lastEyeAspect > 0.02) {
            blinkCount++;
            if (currentType === 'stress' && blinkCount > 3) { // çŸ­æ—¶é—´å†…é¢‘ç¹çœ¨çœ¼
                showAlert('blink');
            }
        }
        lastEyeAspect = eyeDist;

        // A2. å˜´å”‡æ¶ˆå¤± (æŠ¿å˜´)
        const lipTop = results.faceLandmarks[13];
        const lipBottom = results.faceLandmarks[14];
        const lipHeight = Math.abs(lipTop.y - lipBottom.y);
        if (currentType === 'stress' && lipHeight < 0.01) {
            showAlert('lip');
        }

        // --- ZONE B: æ‰‹éƒ¨æ‰«æ ---
       Â 
        // B1. æŠšæ‘¸åé¢ˆ/é”éª¨
        // æ£€æŸ¥æ‰‹éƒ¨æ˜¯å¦é è¿‘è„–å­ (Pose 11/12 æ˜¯è‚©è†€, 9/10 æ˜¯å˜´, å–ä¸­é—´)
        if (results.leftHandLandmarks || results.rightHandLandmarks) {
            const hand = results.leftHandLandmarks || results.rightHandLandmarks;
            const neckY = (results.poseLandmarks[11].y + results.poseLandmarks[12].y) / 2;
            if (hand[0].y < neckY + 0.1 && hand[0].y > neckY - 0.1) { // ç®€å•åˆ¤å®š
                if (currentType === 'stress') showAlert('touch');
            }
        }

        // B2. å†»ç»“ååº” (è®¡ç®—é€Ÿåº¦)
        if (results.rightHandLandmarks) {
            const curr = results.rightHandLandmarks[0];
            if (lastHandPos) {
                const dist = Math.sqrt(Math.pow(curr.x - lastHandPos.x, 2) + Math.pow(curr.y - lastHandPos.y, 2));
                // å¦‚æœåœ¨æ–½å‹æœŸï¼Œæ‰‹å‡ ä¹ä¸åŠ¨ (å†»ç»“)
                if (currentType === 'stress' && dist < 0.001) {
                    showAlert('freeze');
                }
            }
            lastHandPos = curr;
        }

        // --- ZONE C: èº¯å¹²æ‰«æ ---

        // C1. é¾Ÿç¼©æ•ˆåº” (åŒè‚©è€¸èµ·)
        const shoulderLeft = results.poseLandmarks[11];
        const shoulderRight = results.poseLandmarks[12];
        const avgShoulderY = (shoulderLeft.y + shoulderRight.y) / 2;
       Â 
        // åŸºå‡†æœŸè®°å½•è‚©è†€é«˜åº¦
        if (currentType === 'baseline') {
            baselineStats.shoulderY = (baselineStats.shoulderY * frameCount + avgShoulderY) / (frameCount + 1);
            frameCount++;
        }
        // æ–½å‹æœŸå¯¹æ¯”ï¼šå¦‚æœè‚©è†€æ˜æ˜¾å˜é«˜ (Yå€¼å˜å°)
        if (currentType === 'stress') {
            if (avgShoulderY < baselineStats.shoulderY - 0.02) {
                showAlert('shrug');
            }
        }

        // C2. èº¯å¹²é€ƒç¦» (è‚©è†€æ·±åº¦å·®)
        const zDiff = Math.abs(shoulderLeft.z - shoulderRight.z);
        if (currentType === 'stress' && zDiff > 0.2) { // èº«ä½“å¤§å¹…ä¾§è½¬
            showAlert('turn');
        }
    }

    // å·¥å…·: æ˜¾ç¤ºè­¦æŠ¥
    function showAlert(type) {
        alerts[type].style.display = "block";
        // 2ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            alerts[type].style.display = "none";
        }, 2000);
    }
   Â 
    function resetAlerts() {
        Object.values(alerts).forEach(el => el.style.display = 'none');
    }

    // --- MediaPipe æ ‡å‡†æµç¨‹ (ä¿æŒä¸å˜) ---
    const video = document.getElementById('src_video');
    const img = document.getElementById('src_img');
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d');
    const sideCtx = {
        face: document.getElementById('cv_face').getContext('2d'),
        pose: document.getElementById('cv_pose').getContext('2d'),
        hands: document.getElementById('cv_hands').getContext('2d')
    };

    function onResults(results) {
        const width = img.naturalWidth; const height = img.naturalHeight;
        if (width && height) {
            canvas.width = width; canvas.height = height;
            ctx.save(); ctx.clearRect(0, 0, width, height);
            ctx.drawImage(img, 0, 0, width, height);
           Â 
            // ç»˜åˆ¶éª¨æ¶
            drawConnectors(ctx, results.faceLandmarks, FACEMESH_TESSELATION, {color: '#ffffff11', lineWidth: 0.5});
            drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#ffff00aa', lineWidth: 2});
            drawConnectors(ctx, results.leftHandLandmarks, HAND_CONNECTIONS, {color: '#ff00ffaa', lineWidth: 2});
            drawConnectors(ctx, results.rightHandLandmarks, HAND_CONNECTIONS, {color: '#ff00ffaa', lineWidth: 2});
            ctx.restore();

            drawSide(sideCtx.face, results.faceLandmarks, FACEMESH_TESSELATION, '#0ff');
            drawSide(sideCtx.pose, results.poseLandmarks, POSE_CONNECTIONS, '#ff0');
            drawSide(sideCtx.hands, results.leftHandLandmarks, HAND_CONNECTIONS, '#f0f');

            // *** æ³¨å…¥æ–°çš„åˆ†æé€»è¾‘ ***
            analyzeFrame(results);
        }
    }

    function drawSide(c, data, conn, color) {
        c.canvas.width=200; c.canvas.height=200; c.clearRect(0,0,200,200);
        if(data) drawConnectors(c, data, conn, {color: color, lineWidth: 2});
    }

    const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
    holistic.setOptions({modelComplexity: 1, minDetectionConfidence: 0.5});
    holistic.onResults(onResults);

    // äº¤äº’ç»‘å®š
    mainBtn.onclick = () => {
        if (currentState === "finished") {
            window.location.reload(); // ç®€å•é‡ç½®
        } else {
            document.getElementById('file_input').click();
        }
    };

    document.getElementById('file_input').onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;
       Â 
        const reader = new FileReader();
        reader.onload = (evt) => {
            img.src = evt.target.result;
            img.onload = async () => {
                // å¯åŠ¨æµ‹è¯•æµç¨‹
                startInterview();
               Â 
                // æ¨¡æ‹Ÿè§†é¢‘æµï¼šè¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬åœ¨åŒä¸€å¼ å›¾ä¸Šå¾ªç¯è¿è¡Œåˆ†æ
                // (çœŸå®åœºæ™¯ä¸­è¿™é‡Œåº”è¯¥æ˜¯ Video çš„æ¯ä¸€å¸§)
                // æˆ‘ä»¬ç”¨ä¸€ä¸ªå®šæ—¶å™¨æ¯ 100ms é‡æ–°å‘é€è¿™å¼ å›¾ï¼Œæ¨¡æ‹Ÿæ—¶é—´æµé€ï¼Œä»¥ä¾¿è§¦å‘å€’è®¡æ—¶é€»è¾‘
                const simulation = setInterval(async () => {
                    if (currentState === "finished") clearInterval(simulation);
                    await holistic.send({image: img});
                }, 100);
            }
        };
        reader.readAsDataURL(file);
    };
</script>
</body>
</html>
