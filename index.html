<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MindReader V14 - Bio-Metric Recorder</title>
    <style>
        /* --- 1. 赛博档案风格 --- */
        :root { --bg: #000; --panel: #111; --accent: #00f2ff; --warn: #ffcc00; --danger: #ff3366; --text-muted: #666; }
        body { background: var(--bg); color: #fff; margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; font-family: 'Courier New', Courier, monospace; }

        /* --- 2. 视图控制器 --- */
        .view-section { display: none; width: 100%; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; }

        /* --- 3. 实时检测界面 --- */
        .top-bar { height: 120px; background: rgba(20,20,20,0.95); border-bottom: 1px solid #333; padding: 15px; z-index: 50; position: relative; }
        .q-label { font-size: 10px; color: var(--accent); text-transform: uppercase; margin-bottom: 5px; }
        .q-text { font-size: 16px; font-weight: bold; line-height: 1.4; height: 50px; display: flex; align-items: center; }
        .progress-line { position: absolute; bottom: 0; left: 0; height: 3px; background: var(--accent); width: 0%; transition: width 0.1s linear; }

        .stage { flex: 1; position: relative; background: #000; display: flex; justify-content: center; align-items: center; }
        #output_canvas { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); /* 镜像 */ }
        
        .live-stats {
            position: absolute; top: 10px; right: 10px; text-align: right;
            background: rgba(0,0,0,0.5); padding: 5px; border-radius: 4px; font-size: 10px; color: var(--accent);
        }

        /* --- 4. 报告界面 (Dossier) --- */
        .report-container { flex: 1; padding: 20px; overflow-y: auto; background: #050505; }
        .report-header { text-align: center; margin-bottom: 30px; border-bottom: 1px dashed #333; padding-bottom: 20px; }
        .report-title { font-size: 24px; color: var(--accent); margin-bottom: 5px; }
        .report-meta { font-size: 12px; color: var(--text-muted); }

        .timeline-card {
            background: #111; border-left: 3px solid #333; padding: 15px; margin-bottom: 20px;
            position: relative; transition: all 0.3s ease;
        }
        .timeline-card.stress { border-left-color: var(--danger); background: rgba(255, 51, 102, 0.05); }
        .timeline-card.baseline { border-left-color: var(--accent); }
        
        .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12px; color: #888; }
        .card-q { font-size: 14px; font-weight: bold; margin-bottom: 15px; color: #fff; }
        
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px; }
        .data-item { background: #000; padding: 8px; border-radius: 4px; }
        .data-label { color: #666; margin-bottom: 2px; }
        .data-val { font-weight: bold; font-size: 14px; }
        .val-high { color: var(--danger); }
        .val-norm { color: var(--accent); }

        .anomaly-box { 
            margin-top: 10px; padding: 10px; background: rgba(255, 51, 102, 0.1); 
            border: 1px solid var(--danger); color: var(--danger); font-size: 12px;
            display: none; /* 有异常才显示 */
        }

        /* --- 5. 初始覆盖层 --- */
        .start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }
        .start-btn {
            margin-top: 20px; padding: 15px 40px; background: var(--accent); color: #000;
            border: none; font-size: 18px; font-weight: bold; border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.4);
        }

        /* 隐形源 */
        #src_video { display: none; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="view-section active" id="view_start">
    <div class="start-overlay">
        <h1 style="color:var(--accent)">MIND READER V14</h1>
        <p style="color:#666; font-size:12px; margin-top:-10px">BIO-METRIC ANALYSIS SYSTEM</p>
        <div style="margin-top:40px; color:#888; font-size:12px; max-width: 300px;">
            ⚠️ 警告：<br>本系统将调用摄像头进行实时心率与微表情分析。<br>请确保光线充足，正对屏幕。
        </div>
        <button class="start-btn" onclick="initSystem()">启动神经连接</button>
    </div>
</div>

<div class="view-section" id="view_test">
    <div class="top-bar">
        <div class="q-label" id="q_type">CALIBRATING...</div>
        <div class="q-text" id="q_display">初始化传感器...</div>
        <div class="progress-line" id="timer_line"></div>
    </div>
    <div class="stage">
        <div class="live-stats">
            BLINK: <span id="live_blink">0</span><br>
            POSE: <span id="live_pose">STABLE</span>
        </div>
        <canvas id="output_canvas"></canvas>
    </div>
</div>

<div class="view-section" id="view_report">
    <div class="report-container">
        <div class="report-header">
            <div class="report-title">心理侧写报告</div>
            <div class="report-meta">SUBJECT ID: #8921-X • DATE: <span id="report_date"></span></div>
        </div>
        <div id="report_content">
            </div>
        <button class="start-btn" style="width:100%; margin-top:20px; background:#333; color:#fff" onclick="location.reload()">清除档案并重置</button>
    </div>
</div>

<video id="src_video" playsinline></video>

<script>
    // --- 剧本配置 ---
    const SCRIPT = [
        { id: 1, type: 'baseline', time: 8, text: "请保持放松，注视屏幕。\n告诉我，你早餐吃了什么？" },
        { id: 2, type: 'baseline', time: 8, text: "好的。平时休息的时候，\n你更喜欢独处还是和朋友聚会？" },
        { id: 3, type: 'stress', time: 10, text: "听好：\n如果你现在的伴侣和你的母亲同时掉进河里，\n只能救一个，你救谁？立刻回答！" },
        { id: 4, type: 'stress', time: 8, text: "你在撒谎吗？\n为什么刚才你的眼神在躲避？" }
    ];

    // --- 全局状态 ---
    let sessionData = []; // 存储所有问题的分析数据
    let currentQ = null;
    let qTimer = null;
    let startTime = 0;
    
    // 当前题目的临时统计
    let tempStats = {
        blinks: 0,
        frames: 0,
        shoulderYSum: 0,
        handMoveSum: 0,
        lastEyeOpen: true,
        lastHandPos: null
    };

    // --- 系统初始化 ---
    async function initSystem() {
        switchView('view_test');
        document.getElementById('q_display').innerText = "正在接入神经信号...";
        
        const video = document.getElementById('src_video');
        
        // 启动摄像头
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, facingMode: "user" } });
            video.srcObject = stream;
            await video.play();
            
            // 启动 AI
            const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
            holistic.setOptions({modelComplexity: 1, minDetectionConfidence: 0.5});
            holistic.onResults(onResults);
            
            // 启动循环检测
            const camera = new Camera(video, {
                onFrame: async () => { await holistic.send({image: video}); },
                width: 640, height: 480
            });
            camera.start();

            // 3秒后开始第一题
            setTimeout(() => runQuestion(0), 3000);

        } catch (e) {
            alert("摄像头启动失败: " + e.message);
        }
    }

    // --- 流程控制 ---
    function runQuestion(index) {
        if (index >= SCRIPT.length) {
            generateReport();
            return;
        }

        currentQ = SCRIPT[index];
        
        // 重置统计器
        tempStats = { blinks: 0, frames: 0, shoulderYSum: 0, handMoveSum: 0, lastEyeOpen: true, lastHandPos: null };
        startTime = Date.now();

        // UI 更新
        document.getElementById('q_type').innerText = currentQ.type === 'baseline' ? `BASELINE RECORDING #${currentQ.id}` : `STRESS TEST #${currentQ.id}`;
        document.getElementById('q_type').style.color = currentQ.type === 'baseline' ? 'var(--accent)' : 'var(--danger)';
        document.getElementById('q_display').innerText = currentQ.text;
        
        // 进度条动画
        const line = document.getElementById('timer_line');
        line.style.transition = 'none';
        line.style.width = '0%';
        setTimeout(() => {
            line.style.transition = `width ${currentQ.time}s linear`;
            line.style.width = '100%';
        }, 50);

        // 计时结束处理
        setTimeout(() => {
            saveQuestionData();
            runQuestion(index + 1);
        }, currentQ.time * 1000);
    }

    // --- 数据记录 ---
    function saveQuestionData() {
        const durationMin = currentQ.time / 60;
        const avgShoulder = tempStats.frames > 0 ? (tempStats.shoulderYSum / tempStats.frames) : 0;
        const avgHandMove = tempStats.frames > 0 ? (tempStats.handMoveSum / tempStats.frames) : 0;
        
        // 计算 CPM (Counts Per Minute)
        const blinkRate = Math.round(tempStats.blinks / durationMin);

        sessionData.push({
            qId: currentQ.id,
            type: currentQ.type,
            text: currentQ.text,
            stats: {
                blinkRate: blinkRate,
                postureIndex: avgShoulder, // Y越小肩膀越高(耸肩)
                fidgetIndex: avgHandMove // 躁动指数
            }
        });
    }

    // --- 实时 AI 分析 ---
    function onResults(results) {
        // 绘制画面
        const canvas = document.getElementById('output_canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 640; canvas.height = 480;
        ctx.save();
        ctx.clearRect(0, 0, 640, 480);
        ctx.drawImage(document.getElementById('src_video'), 0, 0, 640, 480);
        
        // 简单绘制人脸框
        if(results.faceLandmarks) {
            drawConnectors(ctx, results.faceLandmarks, FACEMESH_TESSELATION, {color: '#ffffff11', lineWidth: 0.5});
        }
        ctx.restore();

        // 如果不在答题期间，不记录数据
        if (!currentQ) return;

        tempStats.frames++;

        // 1. 眨眼计算
        if (results.faceLandmarks) {
            const leftEyeTop = results.faceLandmarks[159].y;
            const leftEyeBottom = results.faceLandmarks[145].y;
            const eyeDist = Math.abs(leftEyeTop - leftEyeBottom);
            
            // 简单阈值判断
            const isClosed = eyeDist < 0.015; 
            if (isClosed && tempStats.lastEyeOpen) {
                tempStats.blinks++;
                document.getElementById('live_blink').innerText = tempStats.blinks;
            }
            tempStats.lastEyeOpen = !isClosed;
        }

        // 2. 姿态 (耸肩检测)
        if (results.poseLandmarks) {
            const shldrY = (results.poseLandmarks[11].y + results.poseLandmarks[12].y) / 2;
            tempStats.shoulderYSum += shldrY;
        }

        // 3. 手部躁动
        if (results.leftHandLandmarks || results.rightHandLandmarks) {
            const hand = results.leftHandLandmarks || results.rightHandLandmarks;
            const currPos = hand[0]; // 手腕
            if (tempStats.lastHandPos) {
                const move = Math.sqrt(Math.pow(currPos.x - tempStats.lastHandPos.x, 2) + Math.pow(currPos.y - tempStats.lastHandPos.y, 2));
                tempStats.handMoveSum += move;
            }
            tempStats.lastHandPos = currPos;
        }
    }

    // --- 报告生成核心逻辑 ---
    function generateReport() {
        switchView('view_report');
        document.getElementById('report_date').innerText = new Date().toLocaleString();
        const container = document.getElementById('report_content');
        
        // 1. 计算基准值 (Q1, Q2 的平均)
        const baselines = sessionData.filter(d => d.type === 'baseline');
        const baseBlink = baselines.reduce((acc, cur) => acc + cur.stats.blinkRate, 0) / baselines.length;
        const basePosture = baselines.reduce((acc, cur) => acc + cur.stats.postureIndex, 0) / baselines.length;

        // 2. 渲染每一题的卡片
        sessionData.forEach(data => {
            const isStress = data.type === 'stress';
            
            // 异常判定逻辑
            let anomalies = [];
            // 眨眼：如果比基准高 50%
            if (isStress && data.stats.blinkRate > baseBlink * 1.5) anomalies.push("眨眼频率激增 (焦虑反应)");
            // 坐姿：如果肩膀位置比基准高 (Y值变小) 
            if (isStress && data.stats.postureIndex < basePosture - 0.02) anomalies.push("双肩明显上耸 (龟缩防御)");
            // 躁动
            if (isStress && data.stats.fidgetIndex > 0.05) anomalies.push("手部多余动作增加 (不安)");

            const html = `
                <div class="timeline-card ${data.type}">
                    <div class="card-header">
                        <span>PHASE: ${data.type.toUpperCase()}</span>
                        <span>QID: ${data.qId}</span>
                    </div>
                    <div class="card-q">"${data.text.replace(/\n/g, ' ')}"</div>
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">BLINK RATE (CPM)</div>
                            <div class="data-val ${anomalies.some(s=>s.includes('眨眼')) ? 'val-high' : 'val-norm'}">${data.stats.blinkRate}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">POSTURE INDEX</div>
                            <div class="data-val">${data.stats.postureIndex.toFixed(3)}</div>
                        </div>
                    </div>
                    ${anomalies.length > 0 ? 
                        `<div class="anomaly-box">⚠ DETECTED: ${anomalies.join(' / ')}</div>` 
                        : ''}
                </div>
            `;
            container.innerHTML += html;
        });

        // 3. 总体结论
        const stressQs = sessionData.filter(d => d.type === 'stress');
        const stressBlink = stressQs.reduce((acc, cur) => acc + cur.stats.blinkRate, 0) / stressQs.length;
        
        let conclusion = "";
        if (stressBlink > baseBlink * 1.5) {
            conclusion = `<div style="text-align:center; padding:20px; border:1px solid var(--danger); color:var(--danger); margin-top:20px">
                <h2>⚠️ 欺骗/高压反应极高</h2>
                <p>施压期眨眼频率比基准期增加了 ${Math.round((stressBlink - baseBlink)/baseBlink * 100)}%</p>
            </div>`;
        } else {
            conclusion = `<div style="text-align:center; padding:20px; border:1px solid var(--accent); color:var(--accent); margin-top:20px">
                <h2>✅ 反应相对诚实/平稳</h2>
                <p>未检测到显著的生理指标波动</p>
            </div>`;
        }
        container.innerHTML += conclusion;
    }

    // --- 工具 ---
    function switchView(id) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
</script>
</body>
</html>
