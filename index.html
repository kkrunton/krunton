<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MindReader V20</title>
    <style>
        /* --- 1. ä¸¥æ ¼æ²¿ç”¨ V18 è§†è§‰é£æ ¼ (å‹¿åŠ¨) --- */
        :root {
            --bg: #000000;
            --glass: rgba(20, 20, 20, 0.85);
            --border: rgba(255, 255, 255, 0.15);
            --accent: #00f2ff; /* V18 ç»å…¸èµ›åšè“ */
            --warn: #ffcc00;  Â 
            --danger: #ff2a6d; /* V18 ç»å…¸è­¦ç¤ºçº¢ */
            --text: #ffffff;
        }

        body {
            background: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", monospace;
            margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
        }

        .app { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; height: 100%; }

        /* é¡¶éƒ¨æ  (V18 å¸ƒå±€) */
        .hud {
            min-height: 100px; background: var(--glass); border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 10px 20px; z-index: 50; flex-shrink: 0; position: relative; backdrop-filter: blur(20px);
        }
        .phase-badge {
            font-size: 10px; font-weight: 800; letter-spacing: 2px; padding: 4px 8px;
            border-radius: 4px; margin-bottom: 8px; text-transform: uppercase; border: 1px solid currentColor;
        }
        .q-text { font-size: 16px; font-weight: 600; text-align: center; line-height: 1.4; max-width: 600px; }
        .progress { position: absolute; bottom: 0; left: 0; height: 4px; background: var(--accent); width: 0%; transition: width 0.1s linear; }

        /* ç›‘æ§åŒº */
        .viewport {
            flex: 1; position: relative; background: #050505; display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        #main_canvas {
            width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1);
        }

        /* å®æ—¶æ ‡ç­¾ (V18 æ ·å¼) */
        .detect-tags {
            position: absolute; top: 10px; right: 10px; display: flex; flex-direction: column; gap: 5px; pointer-events: none;
        }
        .tag {
            background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 4px; font-size: 10px;
            font-weight: bold; border-left: 3px solid; opacity: 0; transition: opacity 0.2s;
        }
        .tag.active { opacity: 1; }
        .tag.danger { border-color: var(--danger); color: var(--danger); }
        .tag.warn { border-color: var(--warn); color: var(--warn); }
        .tag.info { border-color: var(--accent); color: var(--accent); }

        /* åº•éƒ¨ä»ªè¡¨ç›˜ (V18 æ ·å¼) */
        .dashboard {
            height: 120px; background: var(--glass); border-top: 1px solid var(--border);
            display: flex; gap: 10px; padding: 15px; flex-shrink: 0; overflow-x: auto;
            backdrop-filter: blur(20px); padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }
        .dash-card {
            flex: 1; min-width: 90px; background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            border-radius: 8px; position: relative; overflow: hidden;
        }
        .dash-label { position: absolute; top: 5px; left: 5px; font-size: 8px; color: #666; font-weight: bold; }
        .mini-canvas { width: 100%; height: 100%; opacity: 0.6; }

        /* è¦†ç›–å±‚ (V18 æ ·å¼) */
        .layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: opacity 0.3s;
        }
        .layer.hidden { opacity: 0; pointer-events: none; }

        .btn-main {
            margin-top: 30px; padding: 16px 40px; border-radius: 50px; border: none;
            background: linear-gradient(135deg, var(--accent), #0044ff); color: #fff;
            font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
        }

        /* æŠ¥å‘ŠåŒº (V18 æ ·å¼) */
        .report-box { width: 100%; height: 100%; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .evidence-row { display: flex; gap: 10px; margin-bottom: 30px; }
        .photo-card { flex: 1; background: #111; border: 1px solid #333; border-radius: 8px; overflow: hidden; }
        .photo-img { width: 100%; height: auto; display: block; border-bottom: 1px solid #333; }
        .photo-meta { padding: 8px; font-size: 10px; text-align: center; color: #888; text-transform: uppercase; font-weight: bold; }
       Â 
        .log-item {
            background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 10px;
            border-left: 3px solid #555;
        }
        .log-item.stress { border-left-color: var(--danger); background: rgba(255, 42, 109, 0.05); }
        .log-item.trap { border-left-color: var(--warn); background: rgba(255, 204, 0, 0.05); }
        .log-item.baseline { border-left-color: var(--accent); }

        #src_video { display: none; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="layer" id="layer_start">
    <h1 style="letter-spacing: -2px; margin-bottom: 5px;">MindReader <span style="color:var(--accent)">V20</span></h1>
    <p style="color:#666; font-size:12px">FAITHFUL EDITION</p>
    <div style="margin-top:40px; text-align:center; color:#888; font-size:12px; line-height:1.8">
        å·²æ‰©å……åŠ¨æ€å®¡è®¯é€»è¾‘åº“ï¼š<br>
        â€¢ <span style="color:var(--accent)">åŒå€é¢˜åº“</span>: éšæœºæŠ½å–ï¼Œæ‹’ç»èƒŒæ¿<br>
        â€¢ <span style="color:var(--warn)">åŠ¨æ€åšå¼ˆ</span>: å¼‚å¸¸è‡ªåŠ¨è§¦å‘è¿½é—® (Trap)<br>
        â€¢ <span style="color:var(--danger)">ç²¾å‡†æ“åŠ¨</span>: åŒºåˆ†é™æ€äº¤å‰ä¸ç„¦è™‘æ‘©æŒ²<br>
    </div>
    <button class="btn-main" onclick="startSystem()">å¼€å§‹æµ‹è¯•</button>
</div>

<div class="app">
    <div class="hud" id="hud_box">
        <div class="phase-badge" id="hud_badge" style="color:var(--accent); border-color:var(--accent)">SYSTEM READY</div>
        <div class="q-text" id="hud_text">ä¼ æ„Ÿå™¨æ ¡å‡†ä¸­...</div>
        <div class="progress" id="hud_bar"></div>
    </div>

    <div class="viewport">
        <div class="detect-tags">
            <div class="tag danger" id="tag_block">ğŸš¨ è§†çº¿é˜»æ–­ (Blocking)</div>
            <div class="tag danger" id="tag_lip">ğŸ¤ æŠ¿å˜´æ©é¥° (Lip Compress)</div>
            <div class="tag warn" id="tag_rub">ğŸ¤ æ‰‹æŒ‡æ“åŠ¨ (Fidgeting)</div>
            <div class="tag warn" id="tag_cross">ğŸ™…â€â™‚ï¸ åŒè‡‚äº¤å‰ (Defense)</div>
            <div class="tag info" id="tag_shock">ğŸ˜² æƒŠè®¶ååº” (Shock)</div>
        </div>
        <canvas id="main_canvas"></canvas>
    </div>

    <div class="dashboard">
        <div class="dash-card"><div class="dash-label">FACE MESH</div><canvas id="cv_face" class="mini-canvas"></canvas></div>
        <div class="dash-card"><div class="dash-label">SKELETON</div><canvas id="cv_pose" class="mini-canvas"></canvas></div>
        <div class="dash-card"><div class="dash-label">HANDS</div><canvas id="cv_hands" class="mini-canvas"></canvas></div>
    </div>
</div>

<div class="layer hidden" id="layer_report">
    <div class="report-box">
        <h2 style="text-align:center; color:var(--accent); margin-bottom:30px">å¿ƒç†ä¾§å†™æŠ¥å‘Š</h2>
       Â 
        <div style="font-size:12px; color:#888; margin-bottom:10px">EVIDENCE SNAPSHOTS (å…³é”®å¸§)</div>
        <div class="evidence-row" id="evidence_area"></div>

        <div style="font-size:12px; color:#888; margin-bottom:10px">BEHAVIOR LOG (åŠ¨æ€æµæ°´)</div>
        <div id="log_area"></div>

        <button class="btn-main" style="width:100%; background:#333; margin-top:20px" onclick="location.reload()">å½’æ¡£å¹¶é‡ç½®</button>
    </div>
</div>

<video id="src_video" playsinline></video>

<script>
    // --- 1. æ‰©å……é¢˜åº“ (Double Size) ---
    // åŸºå‡†æ±  (é‡‡é›†æ­£å¸¸æ•°æ®)
    const POOL_BASE = [
        "è¯·ç®€å•ä»‹ç»ä¸€ä¸‹ä½ çš„çˆ±å¥½ï¼Ÿ", "ä½ æœ€å–œæ¬¢çš„å­£èŠ‚æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ",
        "ä½ ä»Šå¤©æ—©é¤åƒäº†ä»€ä¹ˆï¼Ÿ", "ä½ å¹³æ—¶å‘¨æœ«ä¸€èˆ¬å‡ ç‚¹èµ·åºŠï¼Ÿ",
        "ä½ å…»è¿‡å® ç‰©å—ï¼Ÿé‚£æ˜¯ç§ä»€ä¹ˆä½“éªŒï¼Ÿ", "æœ€è¿‘çœ‹çš„ä¸€éƒ¨ç”µå½±æ˜¯ä»€ä¹ˆï¼Ÿ"
    ];
    // è½»å‹æ±  (Stress 1 - è¯•æ¢)
    const POOL_STRESS_1 = [
        "ä½ æ˜¯å¦æ›¾ç»å¯¹èº«è¾¹æœ€äº²è¿‘çš„äººæ’’è¿‡è°ï¼Ÿ", "å¦‚æœæŸ¥ä½ çš„æ‰‹æœºç›¸å†Œï¼Œä¼šæœ‰ä¸æƒ³è®©äººçœ‹çš„ä¸œè¥¿å—ï¼Ÿ",
        "ä½ è®¤ä¸ºè‡ªå·±æ˜¯ä¸€ä¸ªç»å¯¹è¯šå®çš„äººå—ï¼Ÿ", "ä½ æ˜¯å¦æ›¾ç»åœ¨æ²¡äººçŸ¥é“çš„æƒ…å†µä¸‹æ‹¿è¿‡ä¸å±äºä½ çš„ä¸œè¥¿ï¼Ÿ"
    ];
    // é«˜å‹æ±  (Stress 2 - è¿›é˜¶)
    const POOL_STRESS_2 = [
        "å¦‚æœä¼´ä¾£å’Œæ¯äº²åŒæ—¶è½æ°´åªèƒ½æ•‘ä¸€ä¸ªï¼Œä½ æ•‘è°ï¼Ÿç«‹åˆ»å›ç­”ï¼",
        "ä½ æ˜¯å¦æ›¾ç»èƒŒå›è¿‡æå…¶ä¿¡ä»»ä½ çš„äººï¼Ÿ",
        "ç”µè½¦éš¾é¢˜ï¼šæ’æ­»ä¸€ä¸ªäº²äººè¿˜æ˜¯äº”ä¸ªé™Œç”Ÿäººï¼Ÿ",
        "ä½ æœ‰æ²¡æœ‰åšè¿‡è‡³ä»Šéƒ½ä¸æ•¢å‘Šè¯‰ä»»ä½•äººçš„äºå¿ƒäº‹ï¼Ÿ"
    ];
    // é™·é˜±æ±  (Trap - è§¦å‘å¼‚å¸¸æ—¶ä½¿ç”¨)
    const POOL_TRAP = [
        "ã€è¿½é—®ã€‘ä½ åœ¨æ’’è°å—ï¼Ÿä¸ºä»€ä¹ˆä½ åˆšæ‰çš„çœ¼ç¥åœ¨èº²é¿ï¼Ÿ",
        "ã€è¿½é—®ã€‘ä½ çš„æ‰‹éƒ¨åŠ¨ä½œå‡ºå–äº†ä½ ï¼Œä½ åœ¨ç´§å¼ ä»€ä¹ˆï¼Ÿ",
        "ã€è¿½é—®ã€‘è¯·çœ‹ç€æˆ‘çš„çœ¼ç›ï¼Œé‡æ–°å›ç­”åˆšæ‰çš„é—®é¢˜ï¼",
        "ã€è¿½é—®ã€‘åˆšæ‰ä½ çš„çœ¨çœ¼é¢‘ç‡é£™å‡ï¼Œä½ åœ¨éšç’ä»€ä¹ˆï¼Ÿ"
    ];

    // å…¨å±€çŠ¶æ€
    let sessionLog = [];
    let currentStep = 0;Â 
    let currentQ = null;
    let evidence = { baseline: null, anomaly: null, maxScore: 0 };
   Â 
    // ç»Ÿè®¡å˜é‡
    let stats = {Â 
        blinks: 0, baseEyeHeight: 0,Â 
        lipCompressCount: 0, eyeBlockCount: 0, shockCount: 0,
        rubFrames: 0, crossFrames: 0, frames: 0,
        lastEyeOpen: true, lastThumbPos: null
    };

    // --- å¯åŠ¨ ---
    async function startSystem() {
        document.getElementById('layer_start').classList.add('hidden');
       Â 
        const video = document.getElementById('src_video');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: "user" } });
            video.srcObject = stream;
            await video.play();

            const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
            holistic.setOptions({modelComplexity: 1, minDetectionConfidence: 0.5, refineFaceLandmarks: true});
            holistic.onResults(onResults);
           Â 
            const camera = new Camera(video, {
                onFrame: async () => { await holistic.send({image: video}); },
                width: 640, height: 480
            });
            camera.start();

            setTimeout(() => runStep(0), 3000);
        } catch (e) { alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥"); }
    }

    // --- 2. åŠ¨æ€é€»è¾‘æ ¸å¿ƒ (The Branching Logic) ---
    function runStep(stepIndex) {
        currentStep = stepIndex;
        // é‡ç½®å½“é¢˜ç»Ÿè®¡ï¼Œä¿ç•™åŸºå‡†å‚æ•°
        const oldBase = stats.baseEyeHeight;
        stats = {Â 
            blinks: 0, lipCompressCount: 0, eyeBlockCount: 0, shockCount: 0,Â 
            rubFrames: 0, crossFrames: 0, frames: 0,Â 
            lastEyeOpen: true, lastThumbPos: null, baseEyeHeight: oldBaseÂ 
        };

        // æ™ºèƒ½é€‰é¢˜ç³»ç»Ÿ
        if (stepIndex === 0) {
            // Base 1
            currentQ = { type: 'baseline', time: 8, text: getRandom(POOL_BASE), id: 1 };
        } else if (stepIndex === 1) {
            // Base 2
            currentQ = { type: 'baseline', time: 8, text: "å¥½çš„ã€‚" + getRandom(POOL_BASE), id: 2 };
        } else if (stepIndex === 2) {
            // æŠ“æ‹ä¸€å¼ åŸºå‡†ç…§
            if (!evidence.baseline) captureEvidence('baseline');
            // Stress 1
            currentQ = { type: 'stress', time: 10, text: getRandom(POOL_STRESS_1), id: 3 };
        } else if (stepIndex === 3) {
            // åˆ†æ”¯åˆ¤æ–­ï¼šæ£€æŸ¥ Q3 çš„å¼‚å¸¸åˆ†
            const prevLog = sessionLog[2];
            if (prevLog && prevLog.score > 20) { // é˜ˆå€¼å¯è°ƒ
                // å¼‚å¸¸ -> é™·é˜±è¿½é—®
                currentQ = { type: 'trap', time: 10, text: getRandom(POOL_TRAP), id: 4 };
            } else {
                // æ­£å¸¸ -> ç»§ç»­åŠ å‹
                currentQ = { type: 'stress', time: 10, text: getRandom(POOL_STRESS_2), id: 4 };
            }
        } else if (stepIndex === 4) {
            // æ£€æŸ¥ Q4
            const prevLog = sessionLog[3];
            // å¦‚æœ Q4 æ˜¯ Stress ä¸”ä¾ç„¶å¼‚å¸¸ -> è¡¥ä¸€åˆ€ Trap
            if (prevLog.q.type === 'stress' && prevLog.score > 20) {
                currentQ = { type: 'trap', time: 10, text: "ã€æœ€ç»ˆè¿½é—®ã€‘ä½ çš„ç”Ÿç†ååº”éå¸¸å‰§çƒˆï¼Œè¯·ç»™æˆ‘ä¸€ä¸ªè§£é‡Šï¼", id: 5 };
            } else {
                generateReport();
                return;
            }
        } else {
            generateReport();
            return;
        }

        updateHUD();
       Â 
        setTimeout(() => {
            finishQuestion();
            runStep(stepIndex + 1);
        }, currentQ.time * 1000);
    }

    function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    function finishQuestion() {
        const cpm = Math.round(stats.blinks / (currentQ.time / 60));
       Â 
        // è®¡ç®—å¼‚å¸¸åˆ† (Score)
        let score = 0;
        if (currentQ.type !== 'baseline') {
            // è·å–åŸºå‡† CPM
            const baseLogs = sessionLog.filter(l => l.q.type === 'baseline');
            const baseCPM = baseLogs.length > 0 ? baseLogs[0].cpm : 20;
           Â 
            if (cpm > baseCPM * 1.4) score += 15; // çœ¨çœ¼æ¿€å¢
            if (stats.eyeBlockCount > 0) score += 10; // è§†çº¿é˜»æ–­
            if (stats.lipCompressCount > 10) score += 10; // æŠ¿å˜´
            if (stats.rubFrames > 15) score += 10; // æ“æ‰‹
            if (stats.crossFrames > 30) score += 5; // æŠ±èƒ¸
        }

        sessionLog.push({ q: currentQ, stats: stats, cpm: cpm, score: score });
    }

    function updateHUD() {
        const badge = document.getElementById('hud_badge');
        const box = document.getElementById('hud_box');
       Â 
        let color = 'var(--accent)';
        if (currentQ.type === 'stress') color = 'var(--warn)';
        if (currentQ.type === 'trap') color = 'var(--danger)';

        badge.innerText = `${currentQ.type.toUpperCase()} PHASE`;
        badge.style.color = color;
        badge.style.borderColor = color;
        // box.style.borderBottomColor = color; // V18 é£æ ¼ä¸è¯¥å˜èƒŒæ™¯ï¼Œåªå˜æ–‡å­—
       Â 
        document.getElementById('hud_text').innerText = currentQ.text;
       Â 
        const bar = document.getElementById('hud_bar');
        bar.style.backgroundColor = color;
        bar.style.transition = 'none'; bar.style.width = '0%';
        setTimeout(() => { bar.style.transition = `width ${currentQ.time}s linear`; bar.style.width = '100%'; }, 50);
    }

    function captureEvidence(type) {
        const canvas = document.getElementById('main_canvas');
        evidence[type] = canvas.toDataURL('image/jpeg', 0.8);
    }

    // --- 3. AI æ ¸å¿ƒ (Rubbing Algorithm Fix) ---
    const canvas = document.getElementById('main_canvas');
    const ctx = canvas.getContext('2d');
    const sideCtx = {
        face: document.getElementById('cv_face').getContext('2d'),
        pose: document.getElementById('cv_pose').getContext('2d'),
        hands: document.getElementById('cv_hands').getContext('2d')
    };

    function onResults(results) {
        const video = document.getElementById('src_video');
        const vW = video.videoWidth; const vH = video.videoHeight;
        if(vW) {
            canvas.width = vW; canvas.height = vH;
            ctx.save(); ctx.clearRect(0, 0, vW, vH); ctx.drawImage(video, 0, 0, vW, vH);
        } else { ctx.restore(); return; }

        if (!results.faceLandmarks) { ctx.restore(); return; }

        const face = results.faceLandmarks;
       Â 
        // A. çœ¨çœ¼/æƒŠè®¶é€»è¾‘
        const leftEyeH = Math.abs(face[159].y - face[145].y);
       Â 
        // é‡‡é›†åŸºå‡†
        if (currentQ && currentQ.type === 'baseline') {
            stats.baseEyeHeight = (stats.baseEyeHeight * stats.frames + leftEyeH) / (stats.frames + 1);
        }

        let frameAnomaly = 0;
        const tags = { block: false, lip: false, rub: false, cross: false, shock: false };

        // çœ¨çœ¼æ£€æµ‹
        const isClosed = leftEyeH < 0.012;
        if (currentQ) {
            if (isClosed && stats.lastEyeOpen) stats.blinks++;
            // è§†çº¿é˜»æ–­ (>1s)
            if (isClosed) {
                if (!stats.closeStart) stats.closeStart = Date.now();
                if (Date.now() - stats.closeStart > 1000) {
                    tags.block = true; stats.eyeBlockCount++; frameAnomaly += 5;
                }
            } else { stats.closeStart = null; }
            stats.lastEyeOpen = !isClosed;
        }

        // æƒŠè®¶æ£€æµ‹ (çªçœ¼)
        if (currentQ && currentQ.type === 'stress' && stats.baseEyeHeight > 0) {
            if (leftEyeH > stats.baseEyeHeight * 1.4) {
                tags.shock = true; stats.shockCount++; frameAnomaly += 5;
            }
        }

        // B. æŠ¿å˜´
        const lipH = Math.abs(face[13].y - face[14].y);
        if (lipH < 0.005) { tags.lip = true; stats.lipCompressCount++; frameAnomaly += 2; }

        // C. æ‰‹éƒ¨é€»è¾‘ (Fix: æ“åŠ¨ vs äº¤å‰)
        const checkHands = () => {
            if (!results.leftHandLandmarks && !results.rightHandLandmarks) return;
           Â 
            // æ“åŠ¨æ£€æµ‹ (Rubbing)
            // åªè¦æœ‰ä¸€åªæ‰‹çš„ æ‹‡æŒ‡(4) å’Œ é£ŸæŒ‡(8) è·ç¦»å¾ˆè¿‘ï¼Œä¸”å‘ç”Ÿäº†ä½ç§»
            [results.leftHandLandmarks, results.rightHandLandmarks].forEach(hand => {
                if(!hand) return;
                const thumb = hand[4]; const index = hand[8];
                const dist = Math.sqrt(Math.pow(thumb.x - index.x, 2) + Math.pow(thumb.y - index.y, 2));
               Â 
                if (dist < 0.05) {
                    // å¦‚æœä¸Šä¸€å¸§ä¹Ÿæœ‰è®°å½•ï¼Œè®¡ç®—ä½ç§»
                    if (stats.lastThumbPos) {
                        const move = Math.sqrt(Math.pow(thumb.x - stats.lastThumbPos.x, 2) + Math.pow(thumb.y - stats.lastThumbPos.y, 2));
                        if (move > 0.005) { // åŠ¨äº†ï¼Œä¸”é åœ¨ä¸€èµ· -> æ“åŠ¨
                            tags.rub = true; stats.rubFrames++; frameAnomaly += 3;
                        }
                    }
                    stats.lastThumbPos = {x: thumb.x, y: thumb.y};
                }
            });
        };
        checkHands();

        // D. æŠ±èƒ¸æ£€æµ‹ (Pose)
        if (results.poseLandmarks) {
            const lWrist = results.poseLandmarks[15]; const rWrist = results.poseLandmarks[16];
            const lShldr = results.poseLandmarks[11]; const rHip = results.poseLandmarks[24];
           Â 
            // éƒ½åœ¨èƒ¸å‰åŒºåŸŸï¼Œä¸”è·ç¦»è¿‘
            if (lWrist.y > lShldr.y && lWrist.y < rHip.y && Math.abs(lWrist.x - rWrist.x) < 0.2) {
                tags.cross = true; stats.crossFrames++; frameAnomaly += 4;
            }
        }

        // ç»˜åˆ¶
        drawConnectors(ctx, face, FACEMESH_TESSELATION, {color: '#ffffff11', lineWidth: 0.5});
       Â 
        // æ›´æ–° UI æ ‡ç­¾
        document.getElementById('tag_block').className = `tag danger ${tags.block ? 'active' : ''}`;
        document.getElementById('tag_lip').className = `tag danger ${tags.lip ? 'active' : ''}`;
        document.getElementById('tag_rub').className = `tag warn ${tags.rub ? 'active' : ''}`;
        document.getElementById('tag_cross').className = `tag warn ${tags.cross ? 'active' : ''}`;
        document.getElementById('tag_shock').className = `tag info ${tags.shock ? 'active' : ''}`;

        // æŠ“æ‹é€»è¾‘ (Trigger)
        if (currentQ && (currentQ.type === 'stress' || currentQ.type === 'trap')) {
            if (frameAnomaly > evidence.maxScore) {
                evidence.maxScore = frameAnomaly;
                captureEvidence('anomaly');
            }
        }

        ctx.restore();
        // ä¾§è¾¹æ é¢„è§ˆ
        drawSide(sideCtx.face, results.faceLandmarks, FACEMESH_TESSELATION, '#00f2ff');
        drawSide(sideCtx.pose, results.poseLandmarks, POSE_CONNECTIONS, '#fff');
        drawSide(sideCtx.hands, results.leftHandLandmarks || results.rightHandLandmarks, HAND_CONNECTIONS, '#ff2a6d');

        if(currentQ) stats.frames++;
    }

    function drawSide(c, data, conn, color) {
        c.canvas.width=150; c.canvas.height=150; c.clearRect(0,0,150,150);
        if(data) { c.save(); drawConnectors(c, data, conn, {color: color, lineWidth: 2}); c.restore(); }
    }

    // --- æŠ¥å‘Šç”Ÿæˆ ---
    function generateReport() {
        document.getElementById('layer_report').classList.remove('hidden');
       Â 
        // 1. ç…§ç‰‡
        const evArea = document.getElementById('evidence_area');
        const imgBase = evidence.baseline || "";
        const imgAnom = evidence.anomaly || imgBase;
        evArea.innerHTML = `
            <div class="photo-card">
                <img src="${imgBase}" class="photo-img">
                <div class="photo-meta" style="color:var(--accent)">BASELINE SNAPSHOT</div>
            </div>
            <div class="photo-card" style="border-color:var(--danger)">
                <img src="${imgAnom}" class="photo-img">
                <div class="photo-meta" style="color:var(--danger)">STRESS PEAK SNAPSHOT</div>
            </div>
        `;

        // 2. æ—¥å¿—
        const logArea = document.getElementById('log_area');
        let html = "";
       Â 
        sessionLog.forEach(d => {
            let signals = [];
            // åŸºå‡†å¯¹æ¯”
            const baseCPM = sessionLog[0].cpm || 20;Â 
           Â 
            if (d.q.type !== 'baseline') {
                if (d.cpm > baseCPM * 1.4) signals.push(`çœ¨çœ¼æ¿€å¢(${d.cpm})`);
                if (d.stats.eyeBlockCount > 0) signals.push("è§†çº¿é˜»æ–­");
                if (d.stats.rubFrames > 20) signals.push("ç„¦è™‘æ“æ‰‹");
                if (d.stats.crossFrames > 30) signals.push("é˜²å¾¡å§¿æ€");
                if (d.stats.shockCount > 5) signals.push("æƒŠè®¶ååº”");
            }

            const hasSignal = signals.length > 0;
            html += `
                <div class="log-item ${d.q.type}">
                    <div style="font-size:10px; opacity:0.6; margin-bottom:5px">${d.q.type.toUpperCase()}</div>
                    <div style="font-weight:bold; margin-bottom:8px">"${d.q.text}"</div>
                    ${hasSignal ? `<div style="color:var(--danger); font-size:12px; font-weight:bold">âš  ${signals.join(", ")}</div>` : '<div style="font-size:12px; opacity:0.5">æ— æ˜æ˜¾å¼‚å¸¸</div>'}
                </div>
            `;
        });
        logArea.innerHTML = html;
    }
</script>
</body>
</html>
