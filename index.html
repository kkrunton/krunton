<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MindReader V16 - Analyst</title>
    <style>
        /* --- 1. 视觉风格 (保持 V15 的高颜值) --- */
        :root {
            --bg-color: #050505;
            --glass-bg: rgba(20, 20, 20, 0.7);
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent-color: #00f2ff;
            --danger-color: #ff3366;
            --text-main: #ffffff;
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 0%, #111 0%, #000 100%);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            margin: 0; height: 100dvh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        .app-container { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; height: 100%; }

        /* --- 2. 顶部 HUD (题目区) --- */
        .top-hud {
            min-height: 90px;
            background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 15px 20px; z-index: 50; flex-shrink: 0; position: relative;
        }
        .phase-tag {
            font-size: 9px; font-weight: 800; letter-spacing: 1px;
            padding: 3px 8px; border-radius: 4px; margin-bottom: 8px; text-transform: uppercase;
        }
        .question-text { font-size: 16px; font-weight: 600; text-align: center; line-height: 1.4; max-width: 90%; }
        .timer-bar { position: absolute; bottom: 0; left: 0; height: 3px; background: var(--accent-color); width: 0%; transition: width 0.1s linear; }

        /* --- 3. 主舞台 (修复相机比例) --- */
        .stage {
            flex: 1; position: relative; display: flex; justify-content: center; align-items: center;
            overflow: hidden; background: #000;
        }
        
        /* 关键修复：使用 object-fit: contain 配合 JS 动态尺寸，防止变形 */
        #output_canvas {
            width: 100%; height: 100%; 
            object-fit: contain; 
            transform: scaleX(-1); /* 镜像 */
        }

        /* 实时数据浮标 */
        .live-stats {
            position: absolute; top: 15px; right: 15px;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            padding: 8px; border-radius: 6px; border: 1px solid var(--glass-border);
            font-size: 10px; text-align: right; line-height: 1.6; pointer-events: none;
        }
        .stat-label { color: #888; margin-right: 5px; }
        .stat-val { font-weight: bold; color: #fff; }

        /* --- 4. 底部侧边栏 --- */
        .sidebar {
            height: 110px; background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
            display: flex; flex-direction: row; padding: 10px; gap: 10px;
            flex-shrink: 0; overflow-x: auto; z-index: 40;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }
        .preview-card {
            flex: 1; min-width: 80px; background: rgba(255,255,255,0.05);
            border-radius: 8px; border: 1px solid var(--glass-border); position: relative; overflow: hidden;
        }
        .card-label { position: absolute; top: 4px; left: 4px; font-size: 8px; color: rgba(255,255,255,0.5); }
        .side-canvas { width: 100%; height: 100%; opacity: 0.7; }

        /* --- 5. 覆盖层 (启动/报告) --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.3s;
        }
        .overlay.hidden { opacity: 0; pointer-events: none; }

        .btn-start {
            margin-top: 30px; padding: 15px 50px; border-radius: 50px; border: none;
            background: linear-gradient(135deg, var(--accent-color), #0051ff);
            color: #fff; font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 10px 30px rgba(0, 242, 255, 0.3);
        }

        /* 报告卡片 */
        .report-container { width: 100%; height: 100%; overflow-y: auto; padding: 20px 20px 80px 20px; box-sizing: border-box; }
        .report-card {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 15px; margin-bottom: 15px;
        }
        .report-card.stress { border-left: 4px solid var(--danger-color); }
        .report-card.baseline { border-left: 4px solid var(--accent-color); }
        
        .analysis-text { margin-top: 10px; font-size: 12px; color: #ccc; line-height: 1.5; padding-top: 10px; border-top: 1px dashed rgba(255,255,255,0.1); }
        .highlight-danger { color: var(--danger-color); font-weight: bold; }
        .highlight-accent { color: var(--accent-color); font-weight: bold; }

        #src_video { display: none; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="overlay" id="start_layer">
    <h1 style="font-weight:800; letter-spacing:-1px">MindReader <span style="color:var(--accent-color)">V16</span></h1>
    <p style="color:#666; font-size:12px">PROFESSIONAL ANALYST EDITION</p>
    <div style="margin-top:40px; text-align:center; color:#888; font-size:12px; line-height:1.6">
        已加载高级分析模块：<br>
        • 躯干中轴偏移检测 (Escape Vector)<br>
        • 面部微表情特征线 (Micro-Expression)<br>
        • 随机压力题库 (Random Stressor)
    </div>
    <button class="btn-start" onclick="startSystem()">启动分析</button>
</div>

<div class="app-container">
    <div class="top-hud">
        <div class="phase-tag" id="hud_phase">SYSTEM READY</div>
        <div class="question-text" id="hud_text">正在校准传感器...</div>
        <div class="timer-bar" id="hud_timer"></div>
    </div>

    <div class="stage">
        <div class="live-stats">
            <div><span class="stat-label">BLINK</span><span class="stat-val" id="val_blink">0</span></div>
            <div><span class="stat-label">TILT</span><span class="stat-val" id="val_tilt">0°</span></div>
            <div><span class="stat-label">MOOD</span><span class="stat-val" id="val_mood">CALM</span></div>
        </div>
        <canvas id="output_canvas"></canvas>
    </div>

    <div class="sidebar">
        <div class="preview-card"><span class="card-label">FACE</span><canvas id="cv_face" class="side-canvas"></canvas></div>
        <div class="preview-card"><span class="card-label">AXIS</span><canvas id="cv_pose" class="side-canvas"></canvas></div>
        <div class="preview-card"><span class="card-label">HANDS</span><canvas id="cv_hands" class="side-canvas"></canvas></div>
    </div>
</div>

<div class="overlay hidden" id="report_layer">
    <div class="report-container">
        <h2 style="color:var(--accent-color); text-align:center; margin-bottom:30px">心理侧写报告</h2>
        <div id="report_content"></div>
        <button class="btn-start" style="width:100%; background:#333; margin-top:20px" onclick="location.reload()">重新测试</button>
    </div>
</div>

<video id="src_video" playsinline></video>

<script>
    // --- 4. 随机题库系统 (Random Question Bank) ---
    const POOL_BASELINE = [
        "请看着镜头，简单介绍一下你的爱好？",
        "你今天早餐吃了什么？详细描述一下。",
        "平时周末你一般喜欢去哪里放松？",
        "你最近看过的一部电影是什么？"
    ];

    const POOL_STRESS = [
        "【社会题】你认为当今社会对你公平吗？为什么？",
        "【道德题】如果你捡到巨款且由于监控死角无人知晓，你会私吞吗？",
        "【高压题】电车难题：一边是你的至亲，一边是五名无辜儿童，你撞谁？",
        "【嫌疑题】你是否曾经背叛过极其信任你的人？看着我回答。",
        "【情感题】伴侣和母亲同时落水，只能救一个，你救谁？立刻回答！"
    ];

    // 随机抽取函数
    function getRandomQuestions() {
        const base = POOL_BASELINE.sort(() => 0.5 - Math.random()).slice(0, 2); // 选2个基准
        const stress = POOL_STRESS.sort(() => 0.5 - Math.random()).slice(0, 2); // 选2个高压
        return [
            { id: 1, type: 'baseline', time: 6, text: base[0] },
            { id: 2, type: 'baseline', time: 6, text: base[1] },
            { id: 3, type: 'stress', time: 10, text: stress[0] }, // 压力题时间长一点
            { id: 4, type: 'stress', time: 10, text: stress[1] }
        ];
    }

    let SCRIPT = []; // 运行时生成
    let sessionData = [];
    let currentQ = null;
    
    // 临时统计数据
    let tempStats = { 
        blinks: 0, 
        tiltSum: 0, 
        frames: 0, 
        lastEyeOpen: true,
        lipTightCount: 0 
    };

    // --- 系统启动 ---
    async function startSystem() {
        document.getElementById('start_layer').classList.add('hidden');
        SCRIPT = getRandomQuestions(); // 生成随机剧本
        
        const video = document.getElementById('src_video');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720, facingMode: "user" } });
            video.srcObject = stream;
            await video.play();

            const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
            holistic.setOptions({modelComplexity: 1, minDetectionConfidence: 0.5, refineFaceLandmarks: true});
            holistic.onResults(onResults);
            
            const camera = new Camera(video, {
                onFrame: async () => { await holistic.send({image: video}); },
                width: 1280, height: 720
            });
            camera.start();

            // 倒计时
            setTimeout(() => runQuestion(0), 3000);

        } catch (e) {
            alert("摄像头启动失败，请检查权限");
        }
    }

    // --- 流程控制 ---
    function runQuestion(index) {
        if (index >= SCRIPT.length) {
            generateReport();
            return;
        }

        currentQ = SCRIPT[index];
        tempStats = { blinks: 0, tiltSum: 0, frames: 0, lastEyeOpen: true, lipTightCount: 0 };
        
        // UI Update
        const isBase = currentQ.type === 'baseline';
        const pTag = document.getElementById('hud_phase');
        pTag.innerText = isBase ? `BASELINE #${currentQ.id}` : `STRESS TEST #${currentQ.id}`;
        pTag.style.background = isBase ? 'rgba(0,242,255,0.2)' : 'rgba(255,51,102,0.2)';
        pTag.style.color = isBase ? 'var(--accent-color)' : 'var(--danger-color)';
        
        document.getElementById('hud_text').innerText = currentQ.text;
        
        // Timer
        const bar = document.getElementById('hud_timer');
        bar.style.transition = 'none'; bar.style.width = '0%';
        setTimeout(() => {
            bar.style.transition = `width ${currentQ.time}s linear`;
            bar.style.width = '100%';
        }, 50);

        setTimeout(() => {
            saveData();
            runQuestion(index + 1);
        }, currentQ.time * 1000);
    }

    function saveData() {
        const avgTilt = tempStats.frames > 0 ? (tempStats.tiltSum / tempStats.frames) : 0;
        const cpm = Math.round(tempStats.blinks / (currentQ.time / 60)); // 眨眼/分钟
        
        sessionData.push({
            q: currentQ,
            stats: { blinkRate: cpm, tilt: avgTilt, lipStress: tempStats.lipTightCount }
        });
    }

    // --- AI 分析 & 绘制 (核心升级) ---
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d');
    const sideCtx = {
        face: document.getElementById('cv_face').getContext('2d'),
        pose: document.getElementById('cv_pose').getContext('2d'),
        hands: document.getElementById('cv_hands').getContext('2d')
    };

    function onResults(results) {
        // 1. 修复相机比例：动态获取视频流尺寸
        const video = document.getElementById('src_video');
        const vW = video.videoWidth;
        const vH = video.videoHeight;
        
        if (vW && vH) {
            canvas.width = vW; canvas.height = vH;
            ctx.save();
            ctx.clearRect(0, 0, vW, vH);
            ctx.drawImage(video, 0, 0, vW, vH);
        }

        if (!results.faceLandmarks && !results.poseLandmarks) { ctx.restore(); return; }

        let currentTilt = 0;
        let isLipTight = false;

        // --- 2. 躯干中轴线系统 (Body Axis) ---
        if (results.poseLandmarks) {
            const pose = results.poseLandmarks;
            const leftShldr = pose[11]; const rightShldr = pose[12];
            const leftHip = pose[23]; const rightHip = pose[24];

            // 计算中点
            const midShldr = { x: (leftShldr.x + rightShldr.x)/2, y: (leftShldr.y + rightShldr.y)/2 };
            const midHip = { x: (leftHip.x + rightHip.x)/2, y: (leftHip.y + rightHip.y)/2 };

            // 计算倾斜角度 (相对于垂直线)
            const dx = midShldr.x - midHip.x;
            const dy = midShldr.y - midHip.y;
            const angle = Math.atan2(dx, dy) * (180 / Math.PI); // 0度是倒立，180是正立
            currentTilt = Math.abs(angle); // 简化处理，只看偏离度
            
            // 绘制中轴线
            const isLeaning = Math.abs(dx) > 0.05; // 偏移阈值
            ctx.beginPath();
            ctx.moveTo(midShldr.x * vW, midShldr.y * vH);
            ctx.lineTo(midHip.x * vW, midHip.y * vH);
            ctx.lineWidth = 4;
            ctx.strokeStyle = isLeaning ? '#ff3366' : '#00f2ff'; // 偏移变红
            ctx.stroke();

            // 绘制肩膀线和髋部线
            ctx.beginPath();
            ctx.moveTo(leftShldr.x * vW, leftShldr.y * vH); ctx.lineTo(rightShldr.x * vW, rightShldr.y * vH);
            ctx.moveTo(leftHip.x * vW, leftHip.y * vH); ctx.lineTo(rightHip.x * vW, rightHip.y * vH);
            ctx.lineWidth = 2;
            ctx.strokeStyle = 'rgba(255,255,255,0.5)';
            ctx.stroke();
            
            // 数据记录
            if (currentQ) tempStats.tiltSum += currentTilt;
            document.getElementById('val_tilt').innerText = Math.abs(angle).toFixed(1) + "°";
        }

        // --- 3. 面部微表情线 (Facial Analysis) ---
        if (results.faceLandmarks) {
            const face = results.faceLandmarks;
            
            // 眼睛线 (EAR)
            const drawEyeLine = (topIdx, botIdx) => {
                const top = face[topIdx]; const bot = face[botIdx];
                const dist = Math.abs(top.y - bot.y);
                const isBlink = dist < 0.015;
                
                ctx.beginPath();
                ctx.moveTo(top.x * vW, top.y * vH);
                ctx.lineTo(bot.x * vW, bot.y * vH);
                ctx.lineWidth = 2;
                ctx.strokeStyle = isBlink ? '#ff3366' : '#00f2ff';
                ctx.stroke();
                return isBlink;
            };
            
            const lBlink = drawEyeLine(159, 145);
            drawEyeLine(386, 374);

            // 眨眼计数逻辑
            if (currentQ) {
                if (lBlink && tempStats.lastEyeOpen) {
                    tempStats.blinks++;
                    document.getElementById('val_blink').innerText = tempStats.blinks;
                }
                tempStats.lastEyeOpen = !lBlink;
            }

            // 嘴部线 (抿嘴检测)
            const lipTop = face[13]; const lipBot = face[14];
            const lipH = Math.abs(lipTop.y - lipBot.y);
            isLipTight = lipH < 0.01; // 抿嘴阈值
            
            ctx.beginPath();
            ctx.moveTo(face[78].x * vW, face[78].y * vH); // 嘴角连线
            ctx.lineTo(face[308].x * vW, face[308].y * vH);
            ctx.lineWidth = isLipTight ? 4 : 2;
            ctx.strokeStyle = isLipTight ? '#ff3366' : '#ffff00';
            ctx.stroke();

            if (currentQ && isLipTight) tempStats.lipTightCount++;
        }

        ctx.restore();
        
        // 更新心情显示
        const moodText = document.getElementById('val_mood');
        if (isLipTight) { moodText.innerText = "TENSE"; moodText.style.color = "#ff3366"; }
        else { moodText.innerText = "CALM"; moodText.style.color = "#00f2ff"; }

        if (currentQ) tempStats.frames++;

        // 绘制侧边栏 (简化)
        drawSide(sideCtx.face, results.faceLandmarks, FACEMESH_TESSELATION, '#00f2ff');
        drawSide(sideCtx.pose, results.poseLandmarks, POSE_CONNECTIONS, '#ffffff');
    }

    function drawSide(c, data, conn, color) {
        c.canvas.width=150; c.canvas.height=150; c.clearRect(0,0,150,150);
        if(data) { c.save(); drawConnectors(c, data, conn, {color: color, lineWidth: 2}); c.restore(); }
    }

    // --- 5. 对比式报告生成 (Deep Analysis) ---
    function generateReport() {
        document.getElementById('report_layer').classList.remove('hidden');
        const container = document.getElementById('report_content');
        
        // 计算基准值
        const baseQs = sessionData.filter(d => d.q.type === 'baseline');
        const avgBaseBlink = baseQs.reduce((a,b)=>a+b.stats.blinkRate,0) / baseQs.length;
        const avgBaseTilt = baseQs.reduce((a,b)=>a+b.stats.tilt,0) / baseQs.length;

        let html = '';
        
        sessionData.forEach(item => {
            const isStress = item.q.type === 'stress';
            let analysis = "";
            let status = "正常";
            let statusClass = "highlight-accent";

            if (isStress) {
                // 对比分析
                const blinkDiff = item.stats.blinkRate - avgBaseBlink;
                const tiltDiff = item.stats.tilt - avgBaseTilt;
                
                let anomalies = [];
                if (blinkDiff > 10) anomalies.push(`眨眼频率激增 (+${blinkDiff} CPM)`);
                if (Math.abs(tiltDiff) > 5) anomalies.push(`躯干明显偏移 (逃离反应)`);
                if (item.stats.lipStress > 10) anomalies.push(`频繁抿嘴 (抑制情绪)`);

                if (anomalies.length > 0) {
                    status = "异常 / 焦虑";
                    statusClass = "highlight-danger";
                    analysis = `检测到压力反应：${anomalies.join('，')}。与基准状态相比，被测者表现出明显的不安。`;
                } else {
                    analysis = "被测者在此压力问题下表现平稳，未检测到显著的生理波动。";
                }
            } else {
                analysis = "基准数据采集完成。";
            }

            html += `
                <div class="report-card ${item.q.type}">
                    <div style="font-size:10px; color:#888; margin-bottom:5px">${item.q.type.toUpperCase()} PHASE</div>
                    <div style="font-size:14px; font-weight:bold; color:#fff; margin-bottom:10px">"${item.q.text}"</div>
                    <div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa;">
                        <span>眨眼: ${item.stats.blinkRate} CPM</span>
                        <span>倾斜: ${item.stats.tilt.toFixed(1)}°</span>
                        <span>状态: <span class="${statusClass}">${status}</span></span>
                    </div>
                    <div class="analysis-text">${analysis}</div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
</script>
</body>
</html>
