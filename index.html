<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MindReader V17 - Evidence</title>
    <style>
        /* --- 视觉风格 (保持不变) --- */
        :root {
            --bg-color: #050505;
            --glass-bg: rgba(20, 20, 20, 0.8);
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent-color: #00f2ff;
            --danger-color: #ff3366;
            --text-main: #ffffff;
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 0%, #111 0%, #000 100%);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            margin: 0; height: 100dvh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        .app-container { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; height: 100%; }

        /* 顶部 HUD */
        .top-hud {
            min-height: 90px;
            background: var(--glass-bg); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 15px 20px; z-index: 50; flex-shrink: 0; position: relative;
        }
        .phase-tag { font-size: 9px; font-weight: 800; padding: 3px 8px; border-radius: 4px; margin-bottom: 8px; text-transform: uppercase; }
        .question-text { font-size: 16px; font-weight: 600; text-align: center; line-height: 1.4; max-width: 90%; }
        .timer-bar { position: absolute; bottom: 0; left: 0; height: 3px; background: var(--accent-color); width: 0%; transition: width 0.1s linear; }

        /* 主舞台 - 修复比例 */
        .stage {
            flex: 1; position: relative; display: flex; justify-content: center; align-items: center;
            overflow: hidden; background: #000;
        }
        #output_canvas {
            width: 100%; height: 100%; 
            object-fit: contain; /* 关键：保持比例，留黑边也不拉伸 */
            transform: scaleX(-1);
        }

        /* 实时状态浮标 */
        .live-stats {
            position: absolute; top: 15px; right: 15px;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            padding: 8px; border-radius: 6px; border: 1px solid var(--glass-border);
            font-size: 10px; text-align: right; line-height: 1.6; pointer-events: none;
        }
        .stat-label { color: #888; margin-right: 5px; }
        .stat-val { font-weight: bold; color: #fff; }

        /* 侧边栏 */
        .sidebar {
            height: 110px; background: var(--glass-bg); backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
            display: flex; flex-direction: row; padding: 10px; gap: 10px;
            flex-shrink: 0; overflow-x: auto; z-index: 40;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }
        .preview-card {
            flex: 1; min-width: 80px; background: rgba(255,255,255,0.05);
            border-radius: 8px; border: 1px solid var(--glass-border); position: relative; overflow: hidden;
        }
        .card-label { position: absolute; top: 4px; left: 4px; font-size: 8px; color: rgba(255,255,255,0.5); }
        .side-canvas { width: 100%; height: 100%; opacity: 0.7; }

        /* 报告页 */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); backdrop-filter: blur(10px);
            z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.3s;
        }
        .overlay.hidden { opacity: 0; pointer-events: none; }

        .btn-start {
            margin-top: 30px; padding: 15px 50px; border-radius: 50px; border: none;
            background: linear-gradient(135deg, var(--accent-color), #0051ff);
            color: #fff; font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 10px 30px rgba(0, 242, 255, 0.3);
        }

        .report-container { width: 100%; height: 100%; overflow-y: auto; padding: 20px 20px 80px 20px; box-sizing: border-box; }
        .report-section-title { font-size: 14px; color: #888; margin: 20px 0 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        /* 证据照片对比区 */
        .evidence-grid { display: flex; gap: 10px; margin-bottom: 20px; }
        .evidence-card { flex: 1; background: #111; border-radius: 8px; overflow: hidden; border: 1px solid #333; }
        .evidence-img { width: 100%; height: auto; display: block; }
        .evidence-tag { 
            background: #222; color: #fff; font-size: 10px; padding: 5px; text-align: center; font-weight: bold; 
        }

        .report-card {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 15px; margin-bottom: 15px;
        }
        .report-card.stress { border-left: 4px solid var(--danger-color); }
        .report-card.baseline { border-left: 4px solid var(--accent-color); }
        
        .analysis-text { margin-top: 10px; font-size: 12px; color: #ccc; line-height: 1.5; padding-top: 10px; border-top: 1px dashed rgba(255,255,255,0.1); }
        .highlight-danger { color: var(--danger-color); font-weight: bold; }

        #src_video { display: none; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="overlay" id="start_layer">
    <h1 style="font-weight:800; letter-spacing:-1px">MindReader <span style="color:var(--accent-color)">V17</span></h1>
    <p style="color:#666; font-size:12px">EVIDENCE RECORDER EDITION</p>
    <div style="margin-top:40px; text-align:center; color:#888; font-size:12px; line-height:1.6">
        已加载法证模块：<br>
        • 广角视野自适应 (Wide FOV)<br>
        • 防御性姿态检测 (Crossed Arms)<br>
        • 视觉证据快照 (Snapshot Log)
    </div>
    <button class="btn-start" onclick="startSystem()">启动监控</button>
</div>

<div class="app-container">
    <div class="top-hud">
        <div class="phase-tag" id="hud_phase">SYSTEM READY</div>
        <div class="question-text" id="hud_text">正在连接中枢...</div>
        <div class="timer-bar" id="hud_timer"></div>
    </div>

    <div class="stage">
        <div class="live-stats">
            <div><span class="stat-label">BLINK</span><span class="stat-val" id="val_blink">0</span></div>
            <div><span class="stat-label">HANDS</span><span class="stat-val" id="val_hand">--</span></div>
            <div><span class="stat-label">FIDGET</span><span class="stat-val" id="val_fidget">0</span></div>
        </div>
        <canvas id="output_canvas"></canvas>
    </div>

    <div class="sidebar">
        <div class="preview-card"><span class="card-label">FACE</span><canvas id="cv_face" class="side-canvas"></canvas></div>
        <div class="preview-card"><span class="card-label">POSE</span><canvas id="cv_pose" class="side-canvas"></canvas></div>
        <div class="preview-card"><span class="card-label">HANDS</span><canvas id="cv_hands" class="side-canvas"></canvas></div>
    </div>
</div>

<div class="overlay hidden" id="report_layer">
    <div class="report-container">
        <h2 style="color:var(--accent-color); text-align:center; margin-bottom:10px">最终心理档案</h2>
        
        <div class="report-section-title">VISUAL EVIDENCE (行为快照对比)</div>
        <div class="evidence-grid" id="evidence_area">
            </div>

        <div class="report-section-title">ANALYSIS LOG (详细分析)</div>
        <div id="report_content"></div>
        
        <button class="btn-start" style="width:100%; background:#333; margin-top:20px" onclick="location.reload()">清除档案</button>
    </div>
</div>

<video id="src_video" playsinline></video>

<script>
    // --- 随机题库 ---
    const POOL_BASELINE = ["请放松，看着镜头。简单介绍一下你最好的朋友？", "你今天早餐吃了什么？味道如何？"];
    const POOL_STRESS = ["【高压】如果你的伴侣和母亲同时落水，只能救一个，你救谁？", "【审讯】看着我的眼睛。你是否做过让你现在感到羞愧的事？"];

    function getRandomQuestions() {
        return [
            { id: 1, type: 'baseline', time: 8, text: POOL_BASELINE[Math.floor(Math.random()*POOL_BASELINE.length)] },
            { id: 2, type: 'baseline', time: 8, text: "好的。平时周末你一般喜欢去哪里放松？" },
            { id: 3, type: 'stress', time: 10, text: POOL_STRESS[Math.floor(Math.random()*POOL_STRESS.length)] },
            { id: 4, type: 'stress', time: 10, text: "你在撒谎吗？为什么你刚才的手部动作突然停了？" }
        ];
    }

    let SCRIPT = [];
    let sessionData = [];
    let currentQ = null;
    let snapshots = { baseline: null, stress: null }; // 存储快照

    // 统计变量
    let tempStats = { 
        blinks: 0, frames: 0, lastEyeOpen: true,
        handMoveSum: 0, lastHandPos: null,
        isCrossedArms: false, crossedFrames: 0
    };

    // --- 启动逻辑 (Wide FOV Fix) ---
    async function startSystem() {
        document.getElementById('start_layer').classList.add('hidden');
        SCRIPT = getRandomQuestions();
        
        const video = document.getElementById('src_video');
        try {
            // 关键修改：不再强制 1280x720，而是请求 ideal: 640。
            // 这样手机通常会给出一个 4:3 的广角画面，而不是 16:9 的裁切画面。
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: "user" } 
            });
            video.srcObject = stream;
            await video.play();

            const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
            holistic.setOptions({modelComplexity: 1, minDetectionConfidence: 0.5, refineFaceLandmarks: true});
            holistic.onResults(onResults);
            
            const camera = new Camera(video, {
                onFrame: async () => { await holistic.send({image: video}); },
                width: 640, height: 480 // 这里只是帧处理尺寸，不影响显示
            });
            camera.start();

            setTimeout(() => runQuestion(0), 3000);
        } catch (e) {
            alert("摄像头启动失败: " + e.message);
        }
    }

    // --- 流程控制 ---
    function runQuestion(index) {
        if (index >= SCRIPT.length) {
            generateReport();
            return;
        }

        // 保存上一题的快照 (如果是关键节点)
        if (index === 2) captureSnapshot('baseline'); // Q2结束时拍一张基准照
        if (index === 4) captureSnapshot('stress');   // Q4结束时拍一张压力照

        currentQ = SCRIPT[index];
        tempStats = { blinks: 0, frames: 0, lastEyeOpen: true, handMoveSum: 0, lastHandPos: null, isCrossedArms: false, crossedFrames: 0 };
        
        // UI 更新
        const isBase = currentQ.type === 'baseline';
        const pTag = document.getElementById('hud_phase');
        pTag.innerText = isBase ? `BASELINE #${currentQ.id}` : `STRESS TEST #${currentQ.id}`;
        pTag.style.color = isBase ? 'var(--accent-color)' : 'var(--danger-color)';
        pTag.style.background = isBase ? 'rgba(0,242,255,0.1)' : 'rgba(255,51,102,0.1)';
        
        document.getElementById('hud_text').innerText = currentQ.text;
        
        // 进度条
        const bar = document.getElementById('hud_timer');
        bar.style.transition = 'none'; bar.style.width = '0%';
        setTimeout(() => {
            bar.style.transition = `width ${currentQ.time}s linear`;
            bar.style.width = '100%';
        }, 50);

        setTimeout(() => {
            saveData();
            runQuestion(index + 1);
        }, currentQ.time * 1000);
    }

    function captureSnapshot(type) {
        const canvas = document.getElementById('output_canvas');
        snapshots[type] = canvas.toDataURL('image/jpeg', 0.8);
    }

    function saveData() {
        const cpm = Math.round(tempStats.blinks / (currentQ.time / 60));
        const fidgetIndex = tempStats.frames > 0 ? (tempStats.handMoveSum / tempStats.frames) : 0;
        const crossedRatio = tempStats.frames > 0 ? (tempStats.crossedFrames / tempStats.frames) : 0;

        sessionData.push({
            q: currentQ,
            stats: { blinkRate: cpm, fidget: fidgetIndex * 100, crossedRatio: crossedRatio }
        });
    }

    // --- AI 分析核心 (V17 Hand Logic) ---
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d');
    const sideCtx = {
        face: document.getElementById('cv_face').getContext('2d'),
        pose: document.getElementById('cv_pose').getContext('2d'),
        hands: document.getElementById('cv_hands').getContext('2d')
    };

    function onResults(results) {
        // 自适应渲染
        const video = document.getElementById('src_video');
        const vW = video.videoWidth; const vH = video.videoHeight;
        if(vW) {
            canvas.width = vW; canvas.height = vH;
            ctx.save(); ctx.clearRect(0, 0, vW, vH); ctx.drawImage(video, 0, 0, vW, vH);
        } else { ctx.restore(); return; }

        if (results.poseLandmarks) {
            // 绘制躯干骨架
            drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#ffffff44', lineWidth: 1});
            
            // --- 手部逻辑升级 (Hand Logic) ---
            const pose = results.poseLandmarks;
            const leftWrist = pose[15]; const rightWrist = pose[16];
            const leftShldr = pose[11]; const rightShldr = pose[12];
            const leftHip = pose[23];   const rightHip = pose[24];

            // 1. 抱胸/防御检测 (Crossed Arms)
            // 简单判定：两个手腕是否都在肩膀以下、髋部以上，并且水平距离很近
            const wristsY = (leftWrist.y + rightWrist.y) / 2;
            const torsoTop = Math.min(leftShldr.y, rightShldr.y);
            const torsoBot = Math.max(leftHip.y, rightHip.y);
            const wristDist = Math.abs(leftWrist.x - rightWrist.x);

            let isCrossed = false;
            if (wristsY > torsoTop && wristsY < torsoBot && wristDist < 0.15) {
                isCrossed = true;
            }

            // 视觉反馈
            if (isCrossed) {
                document.getElementById('val_hand').innerText = "DEFENSIVE (抱胸)";
                document.getElementById('val_hand').style.color = "var(--danger-color)";
                // 画个圈标记防御区
                ctx.beginPath();
                ctx.arc((leftWrist.x + rightWrist.x)/2 * vW, wristsY * vH, 40, 0, 2*Math.PI);
                ctx.strokeStyle = '#ff3366'; ctx.lineWidth = 3; ctx.stroke();
                
                if(currentQ) tempStats.crossedFrames++;
            } else {
                document.getElementById('val_hand').innerText = "OPEN (开放)";
                document.getElementById('val_hand').style.color = "var(--accent-color)";
            }

            // 2. 焦虑摩挲 (Fidgeting)
            // 计算手腕移动的累积量
            if(currentQ) {
                let movement = 0;
                if(tempStats.lastHandPos) {
                    movement = Math.sqrt(Math.pow(leftWrist.x - tempStats.lastHandPos.x, 2) + Math.pow(leftWrist.y - tempStats.lastHandPos.y, 2));
                }
                tempStats.lastHandPos = {x: leftWrist.x, y: leftWrist.y};
                tempStats.handMoveSum += movement;
                
                const fidgetLevel = Math.round(tempStats.handMoveSum * 10);
                document.getElementById('val_fidget').innerText = fidgetLevel;
            }
        }

        // 面部绘制
        if (results.faceLandmarks) {
            drawConnectors(ctx, results.faceLandmarks, FACEMESH_TESSELATION, {color: '#00f2ff22', lineWidth: 0.5});
            
            // 眨眼计数
            const eyeDist = Math.abs(results.faceLandmarks[159].y - results.faceLandmarks[145].y);
            const isClosed = eyeDist < 0.015;
            if(currentQ && isClosed && tempStats.lastEyeOpen) {
                tempStats.blinks++;
                document.getElementById('val_blink').innerText = tempStats.blinks;
            }
            if(currentQ) tempStats.lastEyeOpen = !isClosed;
        }

        ctx.restore();
        
        // 侧边栏预览
        drawSide(sideCtx.face, results.faceLandmarks, FACEMESH_TESSELATION, '#00f2ff');
        drawSide(sideCtx.pose, results.poseLandmarks, POSE_CONNECTIONS, '#ffffff');
        drawSide(sideCtx.hands, results.leftHandLandmarks || results.rightHandLandmarks, HAND_CONNECTIONS, '#ff2a6d');
    }

    function drawSide(c, data, conn, color) {
        c.canvas.width=150; c.canvas.height=150; c.clearRect(0,0,150,150);
        if(data) { c.save(); drawConnectors(c, data, conn, {color: color, lineWidth: 2}); c.restore(); }
    }

    // --- 报告生成 (V17 Evidence) ---
    function generateReport() {
        document.getElementById('report_layer').classList.remove('hidden');
        const container = document.getElementById('report_content');
        const evidenceArea = document.getElementById('evidence_area');

        // 1. 插入证据照片
        if(snapshots.baseline && snapshots.stress) {
            evidenceArea.innerHTML = `
                <div class="evidence-card">
                    <img src="${snapshots.baseline}" class="evidence-img">
                    <div class="evidence-tag" style="color:var(--accent-color)">BASELINE STATE</div>
                </div>
                <div class="evidence-card" style="border-color:var(--danger-color)">
                    <img src="${snapshots.stress}" class="evidence-img">
                    <div class="evidence-tag" style="color:var(--danger-color)">STRESS STATE</div>
                </div>
            `;
        }

        // 2. 生成文字报告
        const baseQs = sessionData.filter(d => d.q.type === 'baseline');
        const avgBlink = baseQs.reduce((a,b)=>a+b.stats.blinkRate,0)/baseQs.length;
        const avgFidget = baseQs.reduce((a,b)=>a+b.stats.fidget,0)/baseQs.length;

        let html = '';
        sessionData.forEach(item => {
            const isStress = item.q.type === 'stress';
            let analysis = [];
            
            // 眨眼分析
            if (isStress && item.stats.blinkRate > avgBlink + 10) analysis.push("眨眼频率异常激增");
            // 抱胸分析
            if (item.stats.crossedRatio > 0.5) analysis.push("长时间保持防御姿态(抱胸)");
            // 焦虑分析
            if (isStress && item.stats.fidget > avgFidget + 5) analysis.push("手部出现明显焦虑性摩挲");

            const isAlert = analysis.length > 0;
            
            html += `
                <div class="report-card ${item.q.type}">
                    <div style="font-size:10px; color:#666; margin-bottom:5px">${item.q.type.toUpperCase()}</div>
                    <div style="color:#fff; font-weight:bold; margin-bottom:10px">"${item.q.text}"</div>
                    <div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa">
                        <span>BLINK: ${item.stats.blinkRate}</span>
                        <span>FIDGET: ${item.stats.fidget.toFixed(1)}</span>
                        <span>CROSS: ${(item.stats.crossedRatio*100).toFixed(0)}%</span>
                    </div>
                    ${isAlert ? `<div class="analysis-text highlight-danger">⚠️ ${analysis.join('，')}</div>` : ''}
                </div>
            `;
        });
        container.innerHTML = html;
        
        // 最后抓拍一张 Stress 状态的快照，如果有的话
        if(!snapshots.stress) captureSnapshot('stress');
    }
</script>
</body>
</html>
